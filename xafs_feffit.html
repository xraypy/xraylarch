
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>14.8. XAFS: Fitting XAFS to Feff Paths &#8212; xraylarch 0.9.81 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/larchdoc.css?v=dfcb3266" />
    
    <script src="_static/documentation_options.js?v=7ce0e41f"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14.9. XAFS: Computing anomalous scattering factors from XAFS data" href="xafs_diffkk.html" />
    <link rel="prev" title="14.7. XAFS: Reading and using Feff Paths" href="xafs_feffpaths.html" />

<script async src="https://badge.dimensions.ai/badge.js" charset="utf-8"></script>

<script type="text/x-mathjax-config">
   MathJax.Hub.Config({ "TeX": {Macros: {AA : "{\\unicode{x212B}}"}}, "HTML-CSS": {scale: 90}});
</script>


  </head><body>
<div style=" color: #c5daba;  text-align: left; height:65px; padding: 0px">
<table border=0>
  <tr>
    <td width=20%>
	<a href="index.html">
	 <img src="_static/larchcones.png" height=50px alt="larchcones"/></a>
    </td>
    <td width=75% padding=0>
      <font size=+2>
	<a href="index.html" style="color:#772211">
	  Larch: Data Analysis Tools for X-ray Spectroscopy
	</a>
      </font>
    </td>
   </tr></table>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="xafs_diffkk.html" title="14.9. XAFS: Computing anomalous scattering factors from XAFS data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="xafs_feffpaths.html" title="14.7. XAFS: Reading and using Feff Paths"
             accesskey="P">previous</a> |</li>
   <li>[<a href="index.html"> Larch</a>|</li>
   <li><a href="getting_started.html"> Getting Started</a>|</li>
   <li><a href="xafs.html">XAFS Analysis</a>|</li>
   <li><a href="xray.html">X-ray Databases</a>|</li>
   <li><a href="xrf.html">XRF Analysis</a>|</li>

          <li class="nav-item nav-item-1"><a href="xafs.html" accesskey="U"><span class="section-number">14. </span>XAFS Analysis</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">14.8. </span>XAFS: Fitting XAFS to Feff Paths</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">14.8. XAFS: Fitting XAFS to Feff Paths</a><ul>
<li><a class="reference internal" href="#the-feffit-strategy-for-modeling-exafs-data">14.8.1. The Feffit Strategy for Modeling EXAFS Data</a></li>
<li><a class="reference internal" href="#fit-statistics-and-goodness-of-fit-meassures-for-feffit">14.8.2. Fit statistics and goodness-of-fit meassures for <code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a></li>
<li><a class="reference internal" href="#the-feffit-functions-in-larch">14.8.3. The Feffit functions in Larch</a></li>
<li><a class="reference internal" href="#feffit-transform-and-the-feffit-transform-group">14.8.4. <code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_transform()</span></code> and the Feffit Transform Group</a><ul>
<li><a class="reference internal" href="#feffit_transform"><code class="docutils literal notranslate"><span class="pre">feffit_transform()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#feffit-dataset">14.8.5. <code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a><ul>
<li><a class="reference internal" href="#feffit_dataset"><code class="docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#feffit">14.8.6. <code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a><ul>
<li><a class="reference internal" href="#id0"><code class="docutils literal notranslate"><span class="pre">feffit()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#feffit-report">14.8.7. <code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_report()</span></code></a><ul>
<li><a class="reference internal" href="#feffit_report"><code class="docutils literal notranslate"><span class="pre">feffit_report()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-1-simple-fit-with-1-path">14.8.8. Example 1: Simple fit with 1 Path</a></li>
<li><a class="reference internal" href="#example-2-fit-1-dataset-with-3-paths">14.8.9. Example 2: Fit 1 dataset with 3 Paths</a></li>
<li><a class="reference internal" href="#example-3-fit-3-datasets-with-1-path-each">14.8.10. Example 3: Fit 3 datasets with 1 Path each</a></li>
<li><a class="reference internal" href="#example-4-measuring-coordination-number">14.8.11. Example 4: Measuring Coordination number</a></li>
<li><a class="reference internal" href="#example-5-comparing-fits-in-different-fit-spaces">14.8.12. Example 5: Comparing Fits in different Fit Spaces</a></li>
<li><a class="reference internal" href="#example-6-testing-exafs-sensitivity-to-z">14.8.13. Example 6: Testing EXAFS sensitivity to <span class="math notranslate nohighlight">\(Z\)</span></a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="xafs_feffpaths.html"
                          title="previous chapter"><span class="section-number">14.7. </span>XAFS: Reading and using Feff Paths</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="xafs_diffkk.html"
                          title="next chapter"><span class="section-number">14.9. </span>XAFS: Computing anomalous scattering factors from XAFS data</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/xafs_feffit.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p><span class="math notranslate nohighlight">\(\newcommand{\AA}{\unicode{x212B}}\)</span></p>
<section id="xafs-fitting-xafs-to-feff-paths">
<h1><span class="section-number">14.8. </span>XAFS: Fitting XAFS to Feff Paths<a class="headerlink" href="#xafs-fitting-xafs-to-feff-paths" title="Link to this heading">¶</a></h1>
<p>Fitting XAFS data with structural models based on Feff calculations is a
primary motivation for Larch.  In this section, we describe how to set up a
fitting model to fit a set of FEFF calculations to XAFS data.  Many parts
of the documentation so far have touched on important aspects of this
process, and those sections will be referenced here.</p>
<section id="the-feffit-strategy-for-modeling-exafs-data">
<h2><span class="section-number">14.8.1. </span>The Feffit Strategy for Modeling EXAFS Data<a class="headerlink" href="#the-feffit-strategy-for-modeling-exafs-data" title="Link to this heading">¶</a></h2>
<p>The basic approach to modeling EXAFS data in Larch (see
<span id="id1">[<a class="reference internal" href="bibliography.html#id51" title="M Newville. Exafs analysis using feff and feffit. Journal of Synchrotron Radiation, 8(Part 2):96-100, 2001. doi:10.1107/S0909049500016290.">Newville (2001)b</a>]</span>) is to create a model EXAFS <span class="math notranslate nohighlight">\(\chi(k)\)</span> as a
sum of scattering path&lt;s that will be compared to experimentally derived
<span class="math notranslate nohighlight">\(\chi(k)\)</span>. The model will consist of a set of FEFF Scattering Paths
representing the photo-electron scattering from different sets of atoms.
As discussed in <a class="reference internal" href="xafs_feffpaths.html#xafs-feffpaths-sec"><span class="std std-ref">XAFS: Reading and using Feff Paths</span></a>, these FEFF Paths have a fixed
set of physically meaningful parameters than can be modified to alter the
predicted contribution to <span class="math notranslate nohighlight">\(\chi(k)\)</span>.  Any of these values can be
defined as algebraic expressions of Larch Parameters defined by
<code class="xref py py-func docutils literal notranslate"><span class="pre">_math.param()</span></code>.  The actual fit uses the same fitting infrastructure
as to <code class="xref py py-func docutils literal notranslate"><span class="pre">_math.minimize()</span></code> to refine the values of the variable
parameters in the model so as to best match the experimental data.  Because
<span class="math notranslate nohighlight">\(\chi(k)\)</span> has known properties and <span class="math notranslate nohighlight">\(k\)</span> dependencies, it is
common to weight and Fourier transform (as described in <a class="reference internal" href="xafs_fourier.html#xafs-ft-sec"><span class="std std-ref">XAFS: Fourier Transforms for XAFS</span></a>)
for the analysis.  In general term, the the refinement process will compare
experimental and model <span class="math notranslate nohighlight">\(\chi(k)\)</span> after a <em>Transformation</em>.</p>
<p>The model for <span class="math notranslate nohighlight">\(\chi(k)\)</span> used to compare to data is</p>
<div class="math notranslate nohighlight">
\[\chi(k) = \sum_{j} \chi_{j}(k, p_j)\]</div>
<p>where <span class="math notranslate nohighlight">\(\chi_j\)</span> is the EXAFS contribution for a FEFF Path, as given in
<a class="reference internal" href="xafs_feffpaths.html#xafs-exafsequation-sec"><span class="std std-ref">The EXAFS Equation using Feff and FeffPath Groups</span></a> for path <span class="math notranslate nohighlight">\(j\)</span>, where <span class="math notranslate nohighlight">\(p_j\)</span> is the
set of adjustable Path Parameters (<span class="math notranslate nohighlight">\(S_0^2\)</span>, <span class="math notranslate nohighlight">\(E_0\)</span>,
<span class="math notranslate nohighlight">\(\delta{R}\)</span>, <span class="math notranslate nohighlight">\(\sigma^2\)</span>, and so on) listed as <code class="docutils literal notranslate"><span class="pre">Adjustable</span></code> in
the <a class="reference internal" href="xafs_feffpaths.html#xafs-pathparams-table"><span class="std std-ref">Table of Feff Path Parameters</span></a>.</p>
<p>The number of FEFF Paths used in the sum can be unlimited, and they do not
need to originate from a single run of FEFF.  This can be important in
modeling even moderately complex structures as a single run of FEFF is
limited to having exactly one absorbing atom in a cluster of atoms and
therefore cannot be used to model multi-site systems without multiple runs.</p>
<p>Because a large number of FEFF Paths could be used to model an XAFS
spectrum, and because each Feff Path has up to 8 adjustable parameters,
there is the potential of having a very large number of parameters for a
fit.  In principle, However, there is a limited amount of information in an
XAFS spectrum.  A simple estimate of how many parameters could be
independently measured is given from information theory of Shannon and
Nyquist as</p>
<div class="math notranslate nohighlight">
\[N_{\rm ind} \approx  \frac{2 \Delta k \Delta R}{\pi} + 1\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta k\)</span> and <span class="math notranslate nohighlight">\(\Delta R\)</span> are the <span class="math notranslate nohighlight">\(k\)</span> and <span class="math notranslate nohighlight">\(R\)</span>
range of the usable data under consideration.  <span id="id2">[<a class="reference internal" href="bibliography.html#id10" title="E. A. Stern. Number of relevant independent points in x-ray-absorption fine-structure spectra. Physical Review B, 48(13):9825–9827, 1993. doi:10.1103/PhysRevB.48.9825.">Stern (1993)</a>]</span>
argues convincingly that the ‘+1’ here should be ‘+2’, but we’ll remain
conservative and keep the ‘+1’, and use this value not only for fit
statistics but to limit the maximum number of free variables allowed in a
fit.  In general, this greatly limits the number of parameters thar can be
successfully used in a fit.  It should be noted that this limitation is
inherent in XAFS (and many other techniques that rely on oscillatory
signals), and not a consequence of using Fourier transforms in the
analysis.</p>
<p>Because of this fundamental information limit, it is usual to purposely
limit the spectra being analyzed.  Of course, one usually limits how far
out in energy to measure a signal based on the strength of the signal
compared to some noise level.  This limits the <span class="math notranslate nohighlight">\(k\)</span> range of useful
data.  In addition, the number of scattering paths that contribute to the
XAFS diverges very quickly with <span class="math notranslate nohighlight">\(R\)</span>.  For any <span class="math notranslate nohighlight">\(R\)</span> interval
then, the finite <span class="math notranslate nohighlight">\(k\)</span> range sets an upper limit on the number of
parameters available for describing the atomic partial pair distribution
function that gives spectral weight in that interval.  The distance to
which a structural model can determined from real XAFS data is therefore
limited to 5 or so Angstroms.  Because of these inherent limitations, it is
generally preferrable to analyze XAFS data by limiting the <span class="math notranslate nohighlight">\(R\)</span> range
of the analysis by using Fourier transforms to convert <span class="math notranslate nohighlight">\(\chi(k)\)</span> to
<span class="math notranslate nohighlight">\(\chi(R)\)</span>.  The <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a> function allows several choices of
data transformations, including doing 0 (<span class="math notranslate nohighlight">\(k\)</span>, unfiltered), 1
(<span class="math notranslate nohighlight">\(R\)</span>, or Fourier transformed), or 2 (math:<cite>q</cite>, or Fourier filtered)
Fourier transforms.   Fitting in unfiltred <span class="math notranslate nohighlight">\(k\)</span> space is generally not
recommended.</p>
</section>
<section id="fit-statistics-and-goodness-of-fit-meassures-for-feffit">
<h2><span class="section-number">14.8.2. </span>Fit statistics and goodness-of-fit meassures for <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a><a class="headerlink" href="#fit-statistics-and-goodness-of-fit-meassures-for-feffit" title="Link to this heading">¶</a></h2>
<p>The fit done by <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a> is conceptually very similar to the fits
described in <a class="reference internal" href="fitting_minimize.html#fitting-minimize-sec"><span class="std std-ref">minimize() and objective Functions</span></a>.   Therefore, many of the
statistics discussed in <a class="reference internal" href="fitting_results.html#fitting-results-sec"><span class="std std-ref">Fit Results and Outputs</span></a> are also generated for
<a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a>. In view of the limited amount of information, some of the
traditional statistical definitions need to be carefully examid, and
possibly altered slightly.   For example, the typical <span class="math notranslate nohighlight">\(\chi^2\)</span>
statistic (as given in <a class="reference internal" href="fitting_overview.html#fitting-overview-sec"><span class="std std-ref">Fitting Overview</span></a>) is</p>
<div class="math notranslate nohighlight">
\[\chi^2 = \sum_{i=1}^{N} \big[\frac{y_i - f(x_i, \vec{\beta})}{\epsilon_i} \big]^2\]</div>
<p>seems simple enough, but actually raises several questions, as we have to
decide what each of the terms here is.  As above, we’ll typically analyze
data in <span class="math notranslate nohighlight">\(R\)</span> space after a Fourier transform, so that the “data”
<span class="math notranslate nohighlight">\(y\)</span> actually represents the real and imaginary components of
<span class="math notranslate nohighlight">\(\chi(R)\)</span>, and the “model” <span class="math notranslate nohighlight">\(f\)</span> will also be the Fourier
transform of the parameterized model for <span class="math notranslate nohighlight">\(\chi(k)\)</span>.</p>
<p>Perhaps the largest questions are ones that are often dismissed as trivial
in standard statistics discussions:</p>
<p>Perhaps surprisingly, the first question is: what is <span class="math notranslate nohighlight">\(N\)</span>?  The
<span class="math notranslate nohighlight">\(\chi(k)\)</span> data can be measured (or sampled) on an arbitrarily fine
grid, and a Fourier transform can use an arbitrary number of points.  Thus,
the number of points for both <span class="math notranslate nohighlight">\(\chi(k)\)</span> and <span class="math notranslate nohighlight">\(\chi(R)\)</span> can
easily be changed without actually changing the quality or quantity of the
real data.  The best number to use for the sum over the number of data
points is then <span class="math notranslate nohighlight">\(N_{\rm ind}\)</span> defined above.  Of course, we generally
oversample the data, so the value for <span class="math notranslate nohighlight">\(\chi^2\)</span> used and reported is</p>
<div class="math notranslate nohighlight">
\[\chi^2 = \frac{N_{\rm ind}}{N}\sum_{i=1}^{N} \big[\frac{y_i - f(x_i, \vec{\beta})}{\epsilon_i} \big]^2\]</div>
<p>where the sum can be over an arbitrary number of samples of <span class="math notranslate nohighlight">\(\chi(k)\)</span>
or <span class="math notranslate nohighlight">\(\chi(R)\)</span>, but the actual range of the data sets <span class="math notranslate nohighlight">\(N_{\rm
ind}\)</span>.</p>
<p>A second consideration is what to use for <span class="math notranslate nohighlight">\(\epsilon\)</span>, the uncertainty
in the “data”.  Of course, the uncertainty in the data, <span class="math notranslate nohighlight">\(\epsilon\)</span>,
depends on the details of the data transformation (for example, whether
fitting in <span class="math notranslate nohighlight">\(R\)</span> or <span class="math notranslate nohighlight">\(q\)</span> space).  Estimating the noise level in
any given spectrum is not at all trivial, and should generally involve a
proper statistical treatment of the data.  For an individual spectrum, what
can be done easily and automatically is to estimate the noise level
assuming that the data is dominated by noise that is independent of
<span class="math notranslate nohighlight">\(R\)</span>: white noise.  The function <a class="reference internal" href="xafs_utilities.html#estimate_noise" title="estimate_noise"><code class="xref py py-func docutils literal notranslate"><span class="pre">estimate_noise()</span></code></a> does this
<span id="id3">[<a class="reference internal" href="bibliography.html#id8" title="M. Newville, B. Boyanov, and D. E. Sayers. Estimation of uncertainties in XAFS data. Journal of Synchrotron Radiation, 6:264–265, 1999. doi:10.1107/S0909049598018147.">Newville, Boyanov, and Sayers (1999)</a>]</span>, and the estimate derived from this method is
used unless you specify a value for <code class="docutils literal notranslate"><span class="pre">epsilon_k</span></code> the noise level in
<span class="math notranslate nohighlight">\(\chi(k)\)</span>.  Though usually <span class="math notranslate nohighlight">\(\epsilon\)</span> is taken to be a scalar
value, it can be specfied as an array (of the same length as
<span class="math notranslate nohighlight">\(\chi(k)\)</span>) if more accurate measures for the uncertainty of the data
is available.</p>
<p>It turns out that <span class="math notranslate nohighlight">\(\chi^2\)</span> is almost always too big, and reduced
<span class="math notranslate nohighlight">\(chi^2\)</span> (that is, <span class="math notranslate nohighlight">\(\chi^2/(p - N_{\rm ind})\)</span> where <span class="math notranslate nohighlight">\(p\)</span> is
the number of fitted parameters) is far greater than 1.  This is partly due
to a poor assessment of the uncertainty in the data, and partly due to
imperfections in the calculations that go into the model.  Together, these
are often called “systematic errors” in the EXAFS literature.  Because of
this issue, an alternative statistic <span class="math notranslate nohighlight">\(\cal{R}\)</span> is often used as a
supplement to <span class="math notranslate nohighlight">\(\chi^2\)</span> for EXAFS.  The <span class="math notranslate nohighlight">\(\cal{R}\)</span> factor is
defined as</p>
<div class="math notranslate nohighlight">
\[{\cal{R}} = \frac{\sum_{i=1}^{N} \big[{y_i - f(x_i, \vec{\beta})}\big]^2}{\sum_{i=1}^{N} {y_i^2}}\]</div>
<p>which is to say, the misfit scaled by the magnitude of the data.</p>
</section>
<section id="the-feffit-functions-in-larch">
<h2><span class="section-number">14.8.3. </span>The Feffit functions in Larch<a class="headerlink" href="#the-feffit-functions-in-larch" title="Link to this heading">¶</a></h2>
<p>The function <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a> is the principle function to do the fit of a
set of Feff paths to XAFS spectra.  This essentially runs
<code class="xref py py-func docutils literal notranslate"><span class="pre">_math.minimize()</span></code> with a parameter group holding all the variable and
constrained parameters, and with a built-in objective function to calculate
the fit residual.  This objective function defines the residual as the
difference of model and experimental <span class="math notranslate nohighlight">\(\chi(k)\)</span> for a list of
<em>Datasets</em>.  Here, a <em>Feffit Dataset</em> is an important concept that will
allow us to easily extend modeling to multiple data sets.</p>
<p>While conceptually fairly simple, the approach is quite general and
flexible, and the level of flexibility can sometimes be daunting.  A
<em>Feffit Dataset</em> has three principle components.  First, it has an
experimental data, <span class="math notranslate nohighlight">\(\chi(k)\)</span>.  Second, it has a list of Feff paths –
that will be used to calculate the model <span class="math notranslate nohighlight">\(\chi(k)\)</span> (using the same
calculation as used by <a class="reference internal" href="xafs_feffpaths.html#ff2chi" title="ff2chi"><code class="xref py py-func docutils literal notranslate"><span class="pre">ff2chi()</span></code></a>).  Third, it has a <em>Feffit Transform</em>
group which holds the Fourier transform and fitting ranges to select how
the data and model are to be compared.  Since the fit is done with a single
group holding all the parameters, it is important that the Path Parameters
for all Feff Paths used in the fits should be written in terms of variable
parameters in a single parameter group.</p>
<p>There are then 3 principle functions for setting up and executing
<a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a>:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><a class="reference internal" href="#feffit_transform" title="feffit_transform"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_transform()</span></code></a> is used to create a Transform group,
which holds the set of Fourier transform parameters, fitting ranges,
and <em>space</em> in which the data and sum of paths are to be compared.</p></li>
<li><p><a class="reference internal" href="#feffit_dataset" title="feffit_dataset"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a> is used to create a Dataset group, which
consists of the three components described above:</p>
<ol class="loweralpha simple">
<li><p>a group holding experimental data (arrays holding <code class="docutils literal notranslate"><span class="pre">k</span></code> and <code class="docutils literal notranslate"><span class="pre">chi</span></code>).</p></li>
<li><p>a list of Feff paths.</p></li>
<li><p>a Transform group.</p></li>
</ol>
</li>
<li><p>Finally, <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a> is run with a parameter group containing
the variable and constrained Parameters for the fit, and a dataset
or list of datasets groups.</p></li>
</ol>
</div></blockquote>
</section>
<section id="feffit-transform-and-the-feffit-transform-group">
<h2><span class="section-number">14.8.4. </span><a class="reference internal" href="#feffit_transform" title="feffit_transform"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_transform()</span></code></a> and the Feffit Transform Group<a class="headerlink" href="#feffit-transform-and-the-feffit-transform-group" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="feffit_transform">
<span class="sig-name descname"><span class="pre">feffit_transform</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fitspace='r'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kmin=0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kmax=20</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kweight=2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">...</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#feffit_transform" title="Link to this definition">¶</a></dt>
<dd><p>create and return Feffit Transform group to be used in a Feffit dataset.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fitspace</strong> – name of FT type for fit: one of (‘k’, ‘r’, ‘q’, ‘w’), default ‘r’.</p></li>
<li><p><strong>kmin</strong> – starting <em>k</em> for FT Window (0).</p></li>
<li><p><strong>kmax</strong> – ending <em>k</em> for FT Window (20).</p></li>
<li><p><strong>dk</strong> – tapering parameter for FT Window (4).</p></li>
<li><p><strong>dk2</strong> – second tapering parameter for FT Window (None).</p></li>
<li><p><strong>window</strong> – name of window type (‘kaiser’).</p></li>
<li><p><strong>nfft</strong> – value to use for <span class="math notranslate nohighlight">\(N_{\rm fft}\)</span> (2048).</p></li>
<li><p><strong>kstep</strong> – value to use for <span class="math notranslate nohighlight">\(\delta{k}\)</span> (0.05).</p></li>
<li><p><strong>kweight</strong> – exponent(s) for weighting spectra by <span class="math notranslate nohighlight">\(k^{\rm kweight}\)</span> (2).</p></li>
<li><p><strong>rmin</strong> – starting <em>R</em> for Fit Range and/or reverse FT Window (0).</p></li>
<li><p><strong>rmax</strong> – ending <em>R</em> for Fit Range and/or reverse FT Window (10).</p></li>
<li><p><strong>dr</strong> – tapering parameter for reverse FT Window 0.</p></li>
<li><p><strong>rwindow</strong> – name of window type for reverse FT Window (‘kaiser’).</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>a Feffit Transform group</p>
</dd>
</dl>
</dd></dl>

<p>The parameters stored in the returned Feffit Transform Group will be used
to control how the fit is performed, including Fourier transform parameters
and fit space for a fit.  All the arguments passed in will be stored as
variables of the same name in the Feffit Transform group.  Additional
variables may be stored in this group as well.</p>
<p>The returned Feffit Transform Group will have members listed in
<a class="reference internal" href="#xafs-feffit-transform-table"><span class="std std-ref">Feffit Transform Group Members</span></a>.</p>
<blockquote id="xafs-feffit-transform-table">
<span id="index-0"></span><div><p>Table of Feffit Transform Group Memebers Most of these parameters
follow the conventions for <a class="reference internal" href="xafs_fourier.html#xftf" title="xftf"><code class="xref py py-func docutils literal notranslate"><span class="pre">xftf()</span></code></a> in section on <a class="reference internal" href="xafs_fourier.html#xafs-ft-sec"><span class="std std-ref">Fourier
Transforms for XAFS</span></a>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>member name</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fitspace</p></td>
<td><p>space used for fitting – one of <code class="docutils literal notranslate"><span class="pre">'k'</span></code>, <code class="docutils literal notranslate"><span class="pre">'r'</span></code>, <code class="docutils literal notranslate"><span class="pre">'q'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'w'</span></code> (<code class="docutils literal notranslate"><span class="pre">'r'</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p>kmin</p></td>
<td><p>starting <span class="math notranslate nohighlight">\(k\)</span> for FT Window (0).</p></td>
</tr>
<tr class="row-even"><td><p>kmax</p></td>
<td><p>ending <span class="math notranslate nohighlight">\(k\)</span> for FT Window  (20).</p></td>
</tr>
<tr class="row-odd"><td><p>kweight</p></td>
<td><p>exponent(s) for weighting spectra by <span class="math notranslate nohighlight">\(k^{\rm kweight}\)</span> (2).</p></td>
</tr>
<tr class="row-even"><td><p>dk</p></td>
<td><p>tapering parameter for FT Window  (4).</p></td>
</tr>
<tr class="row-odd"><td><p>dk2</p></td>
<td><p>second tapering parameter for FT Window (<code class="docutils literal notranslate"><span class="pre">None</span></code> – equal to <code class="docutils literal notranslate"><span class="pre">dk</span></code>).</p></td>
</tr>
<tr class="row-even"><td><p>window</p></td>
<td><p>name of window type for FT (<code class="docutils literal notranslate"><span class="pre">'kaiser'</span></code>).</p></td>
</tr>
<tr class="row-odd"><td><p>kstep</p></td>
<td><p>value to use for <span class="math notranslate nohighlight">\(\delta{k}\)</span> (0.05).</p></td>
</tr>
<tr class="row-even"><td><p>nfft</p></td>
<td><p>value to use for <span class="math notranslate nohighlight">\(N_{\rm fft}\)</span> (2048).</p></td>
</tr>
<tr class="row-odd"><td><p>rmin</p></td>
<td><p>starting <span class="math notranslate nohighlight">\(R\)</span> for back FT Window (0).</p></td>
</tr>
<tr class="row-even"><td><p>rmax</p></td>
<td><p>ending <span class="math notranslate nohighlight">\(R\)</span> for back FT Window (10).</p></td>
</tr>
<tr class="row-odd"><td><p>dr</p></td>
<td><p>tapering parameter for back FT Window (0).</p></td>
</tr>
<tr class="row-even"><td><p>dr2</p></td>
<td><p>second tapering parameter for back FT Window (<code class="docutils literal notranslate"><span class="pre">None</span></code> – equal to <code class="docutils literal notranslate"><span class="pre">dr</span></code>).</p></td>
</tr>
<tr class="row-odd"><td><p>rwindow</p></td>
<td><p>name of window type for back FT (<code class="docutils literal notranslate"><span class="pre">'hanning'</span></code>).</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>As an important note, <code class="docutils literal notranslate"><span class="pre">kweight</span></code> can either be a single integer value, or
a list or tuple of integers.  Supplying more than one value will have the
effect of having <strong>all</strong> the kweights used in the fit.  If multiple
<span class="math notranslate nohighlight">\(k\)</span> weights are provided, they can be in any order – <code class="docutils literal notranslate"><span class="pre">kweight=(1,</span>
<span class="pre">2,</span> <span class="pre">3)</span></code> will produce the same result as <code class="docutils literal notranslate"><span class="pre">kweight=(3,</span> <span class="pre">1,</span> <span class="pre">2)</span></code>.  Some
functions (such as generating output arrays for plotting) may need to
assume 1 <span class="math notranslate nohighlight">\(k\)</span> weight – these will take the first one listed.</p>
</section>
<section id="feffit-dataset">
<h2><span class="section-number">14.8.5. </span><a class="reference internal" href="#feffit_dataset" title="feffit_dataset"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a><a class="headerlink" href="#feffit-dataset" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="feffit_dataset">
<span class="sig-name descname"><span class="pre">feffit_dataset</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pathlist</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[]</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transform</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#feffit_dataset" title="Link to this definition">¶</a></dt>
<dd><blockquote>
<div><p>create a Feffit Dataset group.</p>
<dl class="field-list simple">
<dt class="field-odd">param data<span class="colon">:</span></dt>
<dd class="field-odd"><p>group containing experimental EXAFS (needs arrays <code class="docutils literal notranslate"><span class="pre">k</span></code> and <code class="docutils literal notranslate"><span class="pre">chi</span></code>).</p>
</dd>
<dt class="field-even">param pathlist<span class="colon">:</span></dt>
<dd class="field-even"><p>list of FeffPath groups, as created from <a class="reference internal" href="xafs_feffpaths.html#feffpath" title="feffpath"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffpath()</span></code></a>.</p>
</dd>
<dt class="field-odd">param transform<span class="colon">:</span></dt>
<dd class="field-odd"><p>Feffit Transform group.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><p>a Feffit Dataset group.</p>
</dd>
</dl>
<p>A Dataset group is pretty simple, initially consisting of sub-groups <code class="docutils literal notranslate"><span class="pre">data</span></code>,
<code class="docutils literal notranslate"><span class="pre">pathlist</span></code>, and <code class="docutils literal notranslate"><span class="pre">transform</span></code>, though each of these can be complex.</p>
<p>The value for <code class="docutils literal notranslate"><span class="pre">data</span></code> must be a group containing arrays <code class="docutils literal notranslate"><span class="pre">k</span></code> and
<code class="docutils literal notranslate"><span class="pre">chi</span></code> (as determined <code class="xref py py-func docutils literal notranslate"><span class="pre">_xafs.autobk()</span></code> or some other procedure).
If it contains a value (scalar or array) <code class="docutils literal notranslate"><span class="pre">epsilon_k</span></code>, that will be
used as the uncertainty in <span class="math notranslate nohighlight">\(\chi(k)\)</span> for weighting the fit.
Otherwise, the uncertainty in <span class="math notranslate nohighlight">\(\chi(k)\)</span> will be estimated
automatically, and stored in this dataset.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pathlist</span></code> is a list of Feff Paths, each of which can have its
Path Parameters written in terms of fit parameters (see the final
example in the previous section).  This list of paths will be sent to
<a class="reference internal" href="xafs_feffpaths.html#ff2chi" title="ff2chi"><code class="xref py py-func docutils literal notranslate"><span class="pre">ff2chi()</span></code></a> to calculate the model <span class="math notranslate nohighlight">\(\chi\)</span> to compare to the
experimental data.   Finally, <code class="docutils literal notranslate"><span class="pre">transform</span></code> is a Feffit transform group,
as defined above.</p>
<p>A Dataset will also have a few other components, including:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>component name</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>epsilon_k</p></td>
<td><p>estimated noise in the <span class="math notranslate nohighlight">\(\chi(k)\)</span> data.</p></td>
</tr>
<tr class="row-odd"><td><p>epsilon_r</p></td>
<td><p>estimated noise in the <span class="math notranslate nohighlight">\(\chi(R)\)</span> data.</p></td>
</tr>
<tr class="row-even"><td><p>n_idp</p></td>
<td><p>estimated number of independent points in the data.</p></td>
</tr>
<tr class="row-odd"><td><p>model</p></td>
<td><p>a group for the model <span class="math notranslate nohighlight">\(\chi\)</span> spectrum.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">model</span></code> component will be set after a fit, and will contain the
standard set of arrays for <span class="math notranslate nohighlight">\(\chi(k)\)</span> and <span class="math notranslate nohighlight">\(\chi(R)\)</span> for the
fitting model, and can be directly compared to the arrays for the
experimental data.</p>
</dd></dl>

</section>
<section id="feffit">
<h2><span class="section-number">14.8.6. </span><a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a><a class="headerlink" href="#feffit" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="id0">
<span class="sig-name descname"><span class="pre">feffit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">paramgroup</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">datasets</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rmax_out</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path_outputs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#id0" title="Link to this definition">¶</a></dt>
<dd><p>execute a Feffit fit.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>paramgroup</strong> – group containing parameters for fit</p></li>
<li><p><strong>datasets</strong> – Feffit Dataset group or list of Feffit Dataset group.</p></li>
<li><p><strong>rmax_out</strong> – maximum <span class="math notranslate nohighlight">\(R\)</span> value to calculate output arrays.</p></li>
<li><p><strong>path_output</strong> – Flag to set whether all Path outputs should be written.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>a fit results group.</p>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">paramgroup</span></code> is a group containing all fitting parameters for the
model.  The <code class="docutils literal notranslate"><span class="pre">datasets</span></code> argument can be either a single Feffit Dataset
as created by <a class="reference internal" href="#feffit_dataset" title="feffit_dataset"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a> or a list of them.  If
<code class="docutils literal notranslate"><span class="pre">path_outputs==True</span></code>, all Feff Paths in the fit will be separately
Fourier transformed.</p>
<p>When the fit is completed, the returned value will be a group
containing three objects:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">datasets</span></code>: an array of FeffitDataSet groups used in the fit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>: This will be identical to the input parameter group.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fit</span></code>: an object which points to the low-level fit.</p></li>
</ol>
</div></blockquote>
<p>In addition, the output statistics listed below in <a class="reference internal" href="#xafs-feffit-stats-table"><span class="std std-ref">Table of
Feffit Output Statistics</span></a>.  will be written
the <code class="docutils literal notranslate"><span class="pre">paramgroup</span></code> group.  Since each varied and constrained parameter
will also have best-values and estimated uncertainties, this allows the
parameter group to be considered the principle group for a particular
fit – it holds the variable parameters and statistical results needed
to compare two fits.</p>
<p>On output, a new sub-group called <code class="docutils literal notranslate"><span class="pre">model</span></code> will be created for each
Feffit Dataset. This will parallel the <code class="docutils literal notranslate"><span class="pre">data</span></code> group, in the sense
that it will have output arrays listed in the <a class="reference internal" href="#xafs-feffit-arrays-table"><span class="std std-ref">Table of Feffit
Output Arrays</span></a>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">path_outputs==True</span></code>, all Feff Paths in the fit will be separately
Fourier transformed., with the result being put in the corresponding
FeffPath group.</p>
<p>A final note on the outputs of <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a>: the <code class="docutils literal notranslate"><span class="pre">param</span></code> sub-group in
the output is truly identical to the input <code class="docutils literal notranslate"><span class="pre">paramgroup</span></code>.  It is not a
copy but points to the same group of values (see
<a class="reference internal" href="larchlang/datatypes.html#tutor-objectids-sec"><span class="std std-ref">Object identities, copying, and equality vs. identity</span></a>).</p>
</dd></dl>

<blockquote id="xafs-feffit-stats-table">
<span id="index-1"></span><div><p>Table of Feffit Output Statistics.  These values will be written to the
<code class="docutils literal notranslate"><span class="pre">paramgroup</span></code> group. Listed here are the group component name and a
description of its content.  Many of these are described in more detail
in <a class="reference internal" href="fitting_results.html#fitting-results-sec"><span class="std std-ref">Fit Results and Outputs</span></a></p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>component name</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>chi_reduced</p></td>
<td><p>reduced chi-square statistic.</p></td>
</tr>
<tr class="row-odd"><td><p>chi_square</p></td>
<td><p>chi-square statistic.</p></td>
</tr>
<tr class="row-even"><td><p>covar</p></td>
<td><p>covariance matrix.</p></td>
</tr>
<tr class="row-odd"><td><p>covar_vars</p></td>
<td><p>list of variable names for rows and columns of covariance matrix.</p></td>
</tr>
<tr class="row-even"><td><p>errorbars</p></td>
<td><p>Flag whether error bars could be calculated.</p></td>
</tr>
<tr class="row-odd"><td><p>fit_details</p></td>
<td><p>group with additional fit details.</p></td>
</tr>
<tr class="row-even"><td><p>message</p></td>
<td><p>output message from fit.</p></td>
</tr>
<tr class="row-odd"><td><p>nfree</p></td>
<td><p>number of degrees of freedom in fit.</p></td>
</tr>
<tr class="row-even"><td><p>nvarys</p></td>
<td><p>number of variables in fit.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
<blockquote id="xafs-feffit-arrays-table">
<span id="index-2"></span><div><p>Table of Feffit Output Arrays.  The following arrays will be written
into the <code class="docutils literal notranslate"><span class="pre">data</span></code> and <code class="docutils literal notranslate"><span class="pre">model</span></code> sub-group for each dataset. The arrays
will be created using the Path Parameters used in the most recent fit
and the Feffit Transform group.  Many of these arrays have names
following the conventions for <a class="reference internal" href="xafs_fourier.html#xftf" title="xftf"><code class="xref py py-func docutils literal notranslate"><span class="pre">xftf()</span></code></a> in section on <a class="reference internal" href="xafs_fourier.html#xafs-ft-sec"><span class="std std-ref">Fourier
Transforms for XAFS</span></a>.</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>array name</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>k</p></td>
<td><p>wavenumber array of <span class="math notranslate nohighlight">\(k\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p>chi</p></td>
<td><p><span class="math notranslate nohighlight">\(\chi(k)\)</span>.</p></td>
</tr>
<tr class="row-even"><td><p>kwin</p></td>
<td><p>window <span class="math notranslate nohighlight">\(\Omega(k)\)</span> (length of input chi(k)).</p></td>
</tr>
<tr class="row-odd"><td><p>r</p></td>
<td><p>uniform array of <span class="math notranslate nohighlight">\(R\)</span>, out to <code class="docutils literal notranslate"><span class="pre">rmax_out</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>chir</p></td>
<td><p>complex array of <span class="math notranslate nohighlight">\(\tilde\chi(R)\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p>chir_mag</p></td>
<td><p>magnitude of <span class="math notranslate nohighlight">\(\tilde\chi(R)\)</span>.</p></td>
</tr>
<tr class="row-even"><td><p>chir_pha</p></td>
<td><p>phase of <span class="math notranslate nohighlight">\(\tilde\chi(R)\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p>chir_re</p></td>
<td><p>real part of <span class="math notranslate nohighlight">\(\tilde\chi(R)\)</span>.</p></td>
</tr>
<tr class="row-even"><td><p>chir_im</p></td>
<td><p>imaginary part of <span class="math notranslate nohighlight">\(\tilde\chi(R)\)</span>.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</div></blockquote>
</section>
<section id="feffit-report">
<h2><span class="section-number">14.8.7. </span><a class="reference internal" href="#feffit_report" title="feffit_report"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_report()</span></code></a><a class="headerlink" href="#feffit-report" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="feffit_report">
<span class="sig-name descname"><span class="pre">feffit_report</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fit_result</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#feffit_report" title="Link to this definition">¶</a></dt>
<dd><p>return a printable report from a Feffit fit.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>fit_result</strong> – output group from <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a>.</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="example-1-simple-fit-with-1-path">
<h2><span class="section-number">14.8.8. </span>Example 1: Simple fit with 1 Path<a class="headerlink" href="#example-1-simple-fit-with-1-path" title="Link to this heading">¶</a></h2>
<p>We start with a fairly minimal example, fitting spectra read from a data
file with a single Feff Path.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/feffit/doc_feffit1.lar</span>

<span class="c1"># import needed for python:</span>
<span class="c1">#from larch.io import read_ascii</span>
<span class="c1">#from larch.fitting import param, guess, param_group</span>
<span class="c1">#from larch.xafs import autobk, feffpath, feffit_transform, feffit_dataset, feffit, feffit_report</span>
<span class="c1">#from larch.wxlib.xafsplots import plot_chifit</span>

<span class="c1"># read data</span>
<span class="n">cu_data</span>  <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_metal_rt.xdi&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_data</span><span class="o">.</span><span class="n">mutrans</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">param_group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">del_e0</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">sig2</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">del_r</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># define a Feff Path, give expressions for Path Parameters</span>
<span class="n">path1</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feffcu01.dat&#39;</span><span class="p">,</span>
                 <span class="n">s02</span>    <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span>
                 <span class="n">e0</span>     <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2&#39;</span><span class="p">,</span>
                 <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;del_r&#39;</span><span class="p">)</span>

<span class="c1"># set tranform / fit ranges</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

<span class="c1"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span> <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="c1"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
 
<span class="k">try</span><span class="p">:</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;doc_feffit1.out&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not write doc_feffit1.out&#39;</span><span class="p">)</span>
<span class="c1">#endtry</span>
<span class="c1"># </span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>

<span class="c1">## end examples/feffit/doc_feffit1.lar</span>
</pre></div>
</div>
<p>This simply follows the essential steps:</p>
<blockquote>
<div><p>1. A group of parameters <code class="docutils literal notranslate"><span class="pre">pars</span></code> is defined.  Note that you can include
upper and/or lower bounds and mix the use of <code class="xref py py-func docutils literal notranslate"><span class="pre">_math.guess()</span></code> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">_math.param()</span></code>.</p>
<p>2. A Feff Path is defined with <a class="reference internal" href="xafs_feffpaths.html#feffpath" title="feffpath"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffpath()</span></code></a>, as discussed in the
previous section. Here we assign each of the Path Parameters to the name
of one of the fitting parameters.  More complex expressions and relations
can be used, but for this example, we’re keeping it simple.</p>
<p>3. A Feffit Transform is created with <a class="reference internal" href="#feffit_transform" title="feffit_transform"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_transform()</span></code></a>, which
essentially sets the Fourier transform parameters and fit ranges.</p>
<p>4. A Feffit Dataset is created with <a class="reference internal" href="#feffit_dataset" title="feffit_dataset"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_dataset()</span></code></a>.  To begin the
fit, this includes a <code class="docutils literal notranslate"><span class="pre">data</span></code> group, a <code class="docutils literal notranslate"><span class="pre">transform</span></code> group, and a
<code class="docutils literal notranslate"><span class="pre">pathlist</span></code>,  which is a list of FeffPaths.</p>
<p>5. The fit is run with <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a>, and the output group is saved.
This output group is used by <a class="reference internal" href="#feffit_report" title="feffit_report"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_report()</span></code></a> to generate a fit
report (shown below).</p>
<p>6. Plots are made from the dataset, using rather long-winded <code class="xref py py-func docutils literal notranslate"><span class="pre">plot()</span></code>
commands.</p>
</div></blockquote>
<p>running this example prints out the following report:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">36</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">4</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">104</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">15.2602829</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">112.726669</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">10.0109979</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.00272181</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">38.5161779</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">41.4171921</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">amp</span>                  <span class="o">=</span>  <span class="mf">0.9305631</span> <span class="o">+/-</span> <span class="mf">0.0391214</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">1.0000000</span><span class="p">)</span>
  <span class="n">del_e0</span>               <span class="o">=</span>  <span class="mf">4.3577673</span> <span class="o">+/-</span> <span class="mf">0.5113492</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">del_r</span>                <span class="o">=</span> <span class="o">-</span><span class="mf">0.0060167</span> <span class="o">+/-</span> <span class="mf">0.0026133</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">sig2</span>                 <span class="o">=</span>  <span class="mf">0.0086697</span> <span class="o">+/-</span> <span class="mf">3.0785e-4</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.100</span><span class="p">)</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">sig2</span>            <span class="o">=</span>  <span class="mf">0.928</span>
  <span class="n">del_e0</span><span class="p">,</span> <span class="n">del_r</span>        <span class="o">=</span>  <span class="mf">0.920</span>
  <span class="n">del_r</span><span class="p">,</span> <span class="n">sig2</span>          <span class="o">=</span>  <span class="mf">0.159</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">del_r</span>           <span class="o">=</span>  <span class="mf">0.137</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;dmde5wld&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.400</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">3.000</span><span class="p">,</span> <span class="mf">17.000</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">4.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feffcu01.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">6.1896e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0016546</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0208038</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">15.260</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p3tf6mewg&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feffcu01</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.5478000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">12.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.9305631</span> <span class="o">+/-</span> <span class="mf">0.0391214</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">4.3577673</span> <span class="o">+/-</span> <span class="mf">0.5113492</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.5417833</span> <span class="o">+/-</span> <span class="mf">0.0026133</span>  <span class="o">:=</span> <span class="s1">&#39;reff + del_r&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0060167</span> <span class="o">+/-</span> <span class="mf">0.0026133</span>  <span class="o">:=</span> <span class="s1">&#39;del_r&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0086697</span> <span class="o">+/-</span> <span class="mf">3.0785e-4</span>  <span class="o">:=</span> <span class="s1">&#39;sig2&#39;</span>

<span class="o">=======================================================</span>
</pre></div>
</div>
<p>and generates the plots shown below</p>
<div class="figure compound align-center" id="fig-feffit1">
<figure class="align-default" id="id4">
<span id="fig-feffit1a"></span><a class="reference external image-reference" href="_images/feffit_example1.png"><img alt="_images/feffit_example1.png" src="_images/feffit_example1.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.8.1 </span><span class="caption-text">Results for Feffit for a simple 1-shell fit to a spectrum from Cu
metal.  Data and Fit in <span class="math notranslate nohighlight">\(k\)</span> space</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="fig-feffit1b">
<a class="reference external image-reference" href="_images/feffit_example2.png"><img alt="_images/feffit_example2.png" src="_images/feffit_example2.png" style="width: 100%;" />
</a>
</figure>
<p><span class="caption-text">Results for Feffit for a simple 1-shell fit to a spectrum from Cu
metal.    Data and Fit in <span class="math notranslate nohighlight">\(R\)</span> space</span></p>
</div><p id="fig-feffit1">This is a pretty good fit to the first shell of Cu metal, and shows the
basic mechanics of fitting XAFS data to Feff Paths.  There are several
things that might be added to this for modeling more complex XAFS data,
including adding more paths to a fit, including multiple-scattering paths,
simultaneously modeling more than one data set, and building more complex
fitting models.  We’ll get to these in the following examples.</p>
<p>But first, a small detour.  The plotting commands in the above example for
plotting <span class="math notranslate nohighlight">\(\chi(k)\)</span> and <span class="math notranslate nohighlight">\(\chi(R)\)</span> for data and model will be
useful for the other examples as well, so we’ll create a slightly
generalized function to make such plots and put this and several other
plotting functions into a separate file, <em>doc_macros.lar</em>.  This will look
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>

<span class="k">def</span> <span class="nf">write_report</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="s2">&quot;write report to file&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;could not write </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1">#endtry</span>
<span class="c1">#enddef</span>

<span class="c1">## end of examples/feffit/doc_macros.lar</span>
</pre></div>
</div>
<p>This defines several new plotting functions <a class="reference internal" href="xafs_utilities.html#plot_chifit" title="plot_chifit"><code class="xref py py-func docutils literal notranslate"><span class="pre">plot_chifit()</span></code></a>,
<a class="reference internal" href="xafs_utilities.html#plot_path_k" title="plot_path_k"><code class="xref py py-func docutils literal notranslate"><span class="pre">plot_path_k()</span></code></a>, and <a class="reference internal" href="xafs_utilities.html#plot_path_r" title="plot_path_r"><code class="xref py py-func docutils literal notranslate"><span class="pre">plot_path_r()</span></code></a>, and so on which we’ll find
useful in later examples.  Using the first of these, we can then replace
the plot commands in the script above with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;First shell fit to Cu&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and get reproducible plots without having to copy and paste the same code
fragment everywhere.  We’ll use this in the examples below.</p>
</section>
<section id="example-2-fit-1-dataset-with-3-paths">
<h2><span class="section-number">14.8.9. </span>Example 2: Fit 1 dataset with 3 Paths<a class="headerlink" href="#example-2-fit-1-dataset-with-3-paths" title="Link to this heading">¶</a></h2>
<p>We’ll continue with the Cu data set, and add more paths to model further
shells.  This is fairly straightforward, but in the interest of space,
we’ll limit the example here to 3 paths to model the first two shells of
copper.  This is a small step, but highlights a main concern with XAFS
analysis that we need to address.  This is the fact that there simply is
not enough freedom in the XAFS signal to measure all the possible
adjustable Path Parameters independently.  Thus we need to be able to apply
constraints to the Path Parameters.</p>
<p>Here, we use two of the most common types of constraints.  First, we apply
the same amplitude reduction factor and the same <span class="math notranslate nohighlight">\(E_0\)</span> shift to all
Paths.  These may seem obvious for this example, but for more complicated
examples, either including shells of mixed species or Feff Paths generated
from different calculation, these become less obvious.</p>
<p>Second, we introduce a scale the change in distance by a single expansion
factor <span class="math notranslate nohighlight">\(\alpha\)</span> (<code class="docutils literal notranslate"><span class="pre">alpha</span></code> in the script), and using the built-in
value of half-path distance, <code class="docutils literal notranslate"><span class="pre">reff</span></code>, and setting <code class="docutils literal notranslate"><span class="pre">deltar</span> <span class="pre">=</span>
<span class="pre">'alpha*reff'</span></code> for all Paths.  During the calculation of <span class="math notranslate nohighlight">\(\chi(k)\)</span>
for each path that happens in the fitting process, the value of <code class="docutils literal notranslate"><span class="pre">reff</span></code>
will be updated to the correct value for each path.  Thus, as the value of
<code class="docutils literal notranslate"><span class="pre">alpha</span></code> varies in the fit, each path will use its proper value for
<code class="docutils literal notranslate"><span class="pre">reff</span></code>, so that each <code class="docutils literal notranslate"><span class="pre">deltar</span></code> will be different but not independent.
This ensures that all the path lengths change in a manner consistent with
one another.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/feffit/doc_feffit2.lar</span>

<span class="c1"># import needed for python:</span>
<span class="c1"># from larch.io import read_ascii</span>
<span class="c1"># from larch.fitting import param, guess, param_group</span>
<span class="c1"># from larch.xafs import autobk, feffpath, feffit_transform, feffit_dataset, feffit, feffit_report</span>
<span class="c1"># from larch.wxlib.xafsplots import plot_chifit</span>


<span class="k">def</span> <span class="nf">write_report</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="s2">&quot;write report to file&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;could not write </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="c1">#endtry</span>
<span class="c1">#enddef</span>


<span class="c1"># read data</span>
<span class="n">cu_data</span>  <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_metal_rt.xdi&#39;</span><span class="p">)</span>
<span class="n">cu_data</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">cu_data</span><span class="o">.</span><span class="n">mutrans</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">param_group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>    <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">del_e0</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>    <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">c3_1</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">sig2_1</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">sig2_2</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">sig2_3</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">alpha</span>  <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>    <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># define 3 Feff Path, give expressions for Path Parameters</span>
<span class="n">path1</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2_1&#39;</span><span class="p">,</span>  <span class="n">deltar</span>  <span class="o">=</span> <span class="s1">&#39;alpha*reff&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s1">&#39;c3_1&#39;</span><span class="p">)</span>

<span class="n">path2</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0002.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                 <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2_2&#39;</span><span class="p">,</span>  <span class="n">deltar</span>  <span class="o">=</span> <span class="s1">&#39;alpha*reff&#39;</span><span class="p">)</span>

<span class="n">path3</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0003.dat&#39;</span><span class="p">,</span>     <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                  <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2_3&#39;</span><span class="p">,</span> <span class="n">deltar</span>  <span class="o">=</span> <span class="s1">&#39;alpha*reff&#39;</span><span class="p">)</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.5</span><span class="p">)</span>

<span class="c1"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_data</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">path3</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="c1"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>

<span class="n">report</span> <span class="o">=</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">report</span><span class="p">)</span>

<span class="n">write_report</span><span class="p">(</span><span class="s1">&#39;doc_feffit2.out&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Three-shell fit to Cu&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1">## end examples/feffit/doc_feffit2.lar</span>
</pre></div>
</div>
<p>Here we simply create <code class="docutils literal notranslate"><span class="pre">path2</span></code> and <code class="docutils literal notranslate"><span class="pre">path3</span></code> using nearly the same parameters
as for <code class="docutils literal notranslate"><span class="pre">path1</span></code>.   Compared to the previous example, the other changes
are that the  <span class="math notranslate nohighlight">\(R\)</span> range for the fit has been increased so that the
fit will try to fit the second shell, and that  <code class="docutils literal notranslate"><span class="pre">sigma2</span></code> is allowed to
vary independently for each path.</p>
<p>The output for this fit is a bit longer, being:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">107</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">138</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">19.7166213</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">12.8825327</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">1.01304682</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.00251319</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">5.60880988</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">12.4790439</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">alpha</span>                <span class="o">=</span>  <span class="mf">0.0028114</span> <span class="o">+/-</span> <span class="mf">0.0029801</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">amp</span>                  <span class="o">=</span>  <span class="mf">0.9352796</span> <span class="o">+/-</span> <span class="mf">0.0361711</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">1.0000000</span><span class="p">)</span>
  <span class="n">c3_1</span>                 <span class="o">=</span>  <span class="mf">1.4440e-4</span> <span class="o">+/-</span> <span class="mf">8.2197e-5</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">del_e0</span>               <span class="o">=</span>  <span class="mf">5.7042623</span> <span class="o">+/-</span> <span class="mf">0.8197285</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">3.0000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0086805</span> <span class="o">+/-</span> <span class="mf">2.8390e-4</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0131046</span> <span class="o">+/-</span> <span class="mf">0.0011358</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_3</span>               <span class="o">=</span>  <span class="mf">0.0063292</span> <span class="o">+/-</span> <span class="mf">0.0030901</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.100</span><span class="p">)</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">c3_1</span>          <span class="o">=</span>  <span class="mf">0.952</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">del_e0</span>        <span class="o">=</span>  <span class="mf">0.950</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">sig2_1</span>          <span class="o">=</span>  <span class="mf">0.929</span>
  <span class="n">c3_1</span><span class="p">,</span> <span class="n">del_e0</span>         <span class="o">=</span>  <span class="mf">0.837</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">sig2_2</span>          <span class="o">=</span>  <span class="mf">0.298</span>
  <span class="n">sig2_1</span><span class="p">,</span> <span class="n">sig2_2</span>       <span class="o">=</span>  <span class="mf">0.276</span>
  <span class="n">sig2_1</span><span class="p">,</span> <span class="n">sig2_3</span>       <span class="o">=</span>  <span class="mf">0.213</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">sig2_3</span>          <span class="o">=</span>  <span class="mf">0.213</span>
  <span class="n">c3_1</span><span class="p">,</span> <span class="n">sig2_3</span>         <span class="o">=</span> <span class="o">-</span><span class="mf">0.189</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">amp</span>           <span class="o">=</span>  <span class="mf">0.185</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">sig2_1</span>        <span class="o">=</span>  <span class="mf">0.172</span>
  <span class="n">c3_1</span><span class="p">,</span> <span class="n">sig2_2</span>         <span class="o">=</span>  <span class="mf">0.168</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">sig2_2</span>        <span class="o">=</span>  <span class="mf">0.152</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">sig2_3</span>        <span class="o">=</span> <span class="o">-</span><span class="mf">0.148</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">del_e0</span>          <span class="o">=</span>  <span class="mf">0.148</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">c3_1</span>            <span class="o">=</span>  <span class="mf">0.145</span>
  <span class="n">del_e0</span><span class="p">,</span> <span class="n">sig2_1</span>       <span class="o">=</span>  <span class="mf">0.143</span>
  <span class="n">c3_1</span><span class="p">,</span> <span class="n">sig2_1</span>         <span class="o">=</span>  <span class="mf">0.124</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;d5n7uv6e&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.400</span><span class="p">,</span> <span class="mf">3.500</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">3.000</span><span class="p">,</span> <span class="mf">17.000</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">4.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff0002.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff0003.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0017549</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0058070</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0589825</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">19.717</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p3tf6mewg&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0001</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.5478000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">12.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.9352796</span> <span class="o">+/-</span> <span class="mf">0.0361711</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.7042623</span> <span class="o">+/-</span> <span class="mf">0.8197285</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.5549629</span> <span class="o">+/-</span> <span class="mf">0.0075926</span>  <span class="o">:=</span> <span class="s1">&#39;reff + alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">0.0071629</span> <span class="o">+/-</span> <span class="mf">0.0075926</span>  <span class="o">:=</span> <span class="s1">&#39;alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0086805</span> <span class="o">+/-</span> <span class="mf">2.8390e-4</span>  <span class="o">:=</span> <span class="s1">&#39;sig2_1&#39;</span>
     <span class="n">third</span>  <span class="o">=</span>  <span class="mf">1.4440e-4</span> <span class="o">+/-</span> <span class="mf">8.2197e-5</span>  <span class="o">:=</span> <span class="s1">&#39;c3_1&#39;</span>

 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;pj3m4qvfy&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0002</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>      <span class="o">-</span><span class="mf">3.6032</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">3.6032000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">6.0000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.9352796</span> <span class="o">+/-</span> <span class="mf">0.0361711</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.7042623</span> <span class="o">+/-</span> <span class="mf">0.8197285</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">3.6133300</span> <span class="o">+/-</span> <span class="mf">0.0107377</span>  <span class="o">:=</span> <span class="s1">&#39;reff + alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">0.0101300</span> <span class="o">+/-</span> <span class="mf">0.0107377</span>  <span class="o">:=</span> <span class="s1">&#39;alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0131046</span> <span class="o">+/-</span> <span class="mf">0.0011358</span>  <span class="o">:=</span> <span class="s1">&#39;sig2_2&#39;</span>

 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;pibakl7xe&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0003</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">1.8016</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">1</span>
              <span class="n">Cu</span>       <span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">3.8218000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">48.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.9352796</span> <span class="o">+/-</span> <span class="mf">0.0361711</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.7042623</span> <span class="o">+/-</span> <span class="mf">0.8197285</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">3.8325446</span> <span class="o">+/-</span> <span class="mf">0.0113892</span>  <span class="o">:=</span> <span class="s1">&#39;reff + alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">0.0107446</span> <span class="o">+/-</span> <span class="mf">0.0113892</span>  <span class="o">:=</span> <span class="s1">&#39;alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0063292</span> <span class="o">+/-</span> <span class="mf">0.0030901</span>  <span class="o">:=</span> <span class="s1">&#39;sig2_3&#39;</span>

<span class="o">=======================================================</span>
</pre></div>
</div>
<p>With plots of data and fits as shown below.</p>
<div class="figure compound align-center" id="fig-feffit2">
<figure class="align-default" id="fig-feffit2a">
<a class="reference external image-reference" href="_images/feffit_example3.png"><img alt="_images/feffit_example3.png" src="_images/feffit_example3.png" style="width: 100%;" />
</a>
</figure>
<figure class="align-default" id="fig-feffit2b">
<a class="reference external image-reference" href="_images/feffit_example4.png"><img alt="_images/feffit_example4.png" src="_images/feffit_example4.png" style="width: 100%;" />
</a>
</figure>
<p><span class="caption-text">Results for Feffit for a 3-shell fit to a spectrum from Cu metal,
constraining all path distances to expand with a single variable.</span></p>
</div><p id="fig-feffit2">Here, we show both the magnitude and real part of <span class="math notranslate nohighlight">\(\chi(R)\)</span>.  The fit
to the real part shows excellent agreement over the fit <span class="math notranslate nohighlight">\(R\)</span> range of
[1.4, 3.4] <span class="math notranslate nohighlight">\(\AA\)</span>.  It is often useful the contributions from the
individual paths.  With the macros defined above, this is pretty
straightforward, as we can just do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_modelpaths_k</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot_modelpaths_r</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>to generate the following plots of the contributions of the different paths:</p>
<div class="figure compound align-center" id="fig-feffit3">
<figure class="align-default" id="fig-feffit3a">
<a class="reference external image-reference" href="_images/feffit_example5.png"><img alt="_images/feffit_example5.png" src="_images/feffit_example5.png" style="width: 100%;" />
</a>
</figure>
<figure class="align-default" id="fig-feffit3b">
<a class="reference external image-reference" href="_images/feffit_example6.png"><img alt="_images/feffit_example6.png" src="_images/feffit_example6.png" style="width: 100%;" />
</a>
</figure>
<p><span class="caption-text">Path contributions to full mode for the 3-shell fit to Cu spectrum.</span></p>
</div></section>
<section id="example-3-fit-3-datasets-with-1-path-each">
<span id="fig-feffit3"></span><h2><span class="section-number">14.8.10. </span>Example 3: Fit 3 datasets with 1 Path each<a class="headerlink" href="#example-3-fit-3-datasets-with-1-path-each" title="Link to this heading">¶</a></h2>
<p>We’ll extend the above example by adding two more data sets.  Since the
three data sets have some things in common, we’ll be able to use some a
smaller number of total variable parameters for all data sets than if we
had fit each of them individually.  This further allows us to reduce the
number of freely varying parameters in a model of XAFS data, and to better
measure the parameters that are varied.</p>
<p>Here, we’ll use data on Cu metal measured at three different temperatures.
Since there is no phase change in the material over this temperature range,
the structure changes in small and predictable ways that lends itself to
simple parameterization.  In the interest of brevity, we’ll only use one
path, but the example could easily be extended to include more paths.</p>
<p>In this example, we have three distinct datasets, so we’ll have three lists
of paths.  Each of these will have a single path.  Since we’re modeling
nearly the same structure, the three paths will use the same Feff.dat file
and have many parameters in common, but some parameters will be different
for each data set.  As with the previous example, we use the same amplitude
reduction factor <span class="math notranslate nohighlight">\(E_0\)</span> shift to all data sets.  We allow distances to
vary, but constrain them so that the change is linear in the sample
temperature, as if there were a simple linear expansion in <span class="math notranslate nohighlight">\(R\)</span>.  To
do this, we set <code class="docutils literal notranslate"><span class="pre">deltar</span> <span class="pre">=</span> <span class="pre">'dr_off</span> <span class="pre">+</span> <span class="pre">T*alpha*reff'</span></code>, where <code class="docutils literal notranslate"><span class="pre">T</span></code> is the
temperature for the dataset.  For <span class="math notranslate nohighlight">\(\sigma^2\)</span> we’ll use one of the
built-in models described in <a class="reference internal" href="xafs_feffpaths.html#xafs-sigma2calcs-sec"><span class="std std-ref">Models for Calculating sigma2</span></a>.  Here we’ll use <a class="reference internal" href="xafs_feffpaths.html#sigma2_eins" title="sigma2_eins"><code class="xref py py-func docutils literal notranslate"><span class="pre">sigma2_eins()</span></code></a>, but
<a class="reference internal" href="xafs_feffpaths.html#sigma2_debye" title="sigma2_debye"><code class="xref py py-func docutils literal notranslate"><span class="pre">sigma2_debye()</span></code></a> can be used as well, and does a better job for
multiple-scattering paths in simple systems.  The model then uses 2
variable parameters for three temperature-dependent distances and 1
variable parameter for three temperature-dependent mean-square
displacements. The full script for the fit looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/feffit/doc_feffit3.lar</span>

<span class="c1"># read 3 datasets</span>
<span class="n">cu_10</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_10k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_10</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_10</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_10</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">cu_50</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_50k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_50</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_50</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_50</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">cu_150</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_150k.xmu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">cu_150</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cu_150</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">cu_150</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">del_e0</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
             <span class="n">theta</span>  <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">dr_off</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
             <span class="n">alpha</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># define 3 Feff Path, give expressions for Path Parameters</span>
<span class="n">path1_10</span>  <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;dr_off + 10*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sigma2_eins(10, theta)&#39;</span><span class="p">)</span>


<span class="n">path1_50</span>  <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;dr_off + 50*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sigma2_eins(50, theta)&#39;</span><span class="p">)</span>

<span class="n">path1_150</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">,</span>  <span class="n">s02</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="s1">&#39;del_e0&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;dr_off + 150*alpha*reff&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sigma2_eins(150, theta)&#39;</span><span class="p">)</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.4</span><span class="p">)</span>

<span class="c1"># define 3 datasets, each with data, pathlist, transform for each</span>
<span class="n">dset_10</span>   <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_10</span><span class="p">,</span>  <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_10</span><span class="p">],</span>  <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">dset_50</span>   <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_50</span><span class="p">,</span>  <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_50</span><span class="p">],</span>  <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">dset_150</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cu_150</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path1_150</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="c1"># perform fit!</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="p">[</span><span class="n">dset_10</span><span class="p">,</span> <span class="n">dset_50</span><span class="p">,</span> <span class="n">dset_150</span><span class="p">])</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span> <span class="n">report</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="s1">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">write_report</span><span class="p">(</span><span class="s1">&#39;doc_feffit3.out&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_10</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;fit to Cu, 10K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_50</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;fit to Cu, 50K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset_150</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;fit to Cu, 150K&#39;</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># ## end examples/feffit/doc_feffit3.lar</span>
</pre></div>
</div>
<p>Here we read in 3 datasets for <span class="math notranslate nohighlight">\(\mu(E)\)</span> data and do the background
subtraction on each of them.  We define 5 fitting parameters, including the
characteristic (here, Einstein) temperature which will determine the value of
<span class="math notranslate nohighlight">\(\sigma^2\)</span>, and two parameters for the linear temperature dependence
of <span class="math notranslate nohighlight">\(R\)</span>. The output for this fit is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">25</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">5</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">390</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">56.4760609</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">2965.82273</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">57.6155727</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.01636032</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">233.706924</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">243.876008</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">alpha</span>                <span class="o">=</span>  <span class="mf">5.2949e-6</span> <span class="o">+/-</span> <span class="mf">6.6608e-6</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">amp</span>                  <span class="o">=</span>  <span class="mf">0.8884690</span> <span class="o">+/-</span> <span class="mf">0.0307237</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">1.0000000</span><span class="p">)</span>
  <span class="n">del_e0</span>               <span class="o">=</span>  <span class="mf">5.3732949</span> <span class="o">+/-</span> <span class="mf">0.6134197</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">2.0000000</span><span class="p">)</span>
  <span class="n">dr_off</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">3.0553e-4</span> <span class="o">+/-</span> <span class="mf">0.0027193</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">theta</span>                <span class="o">=</span>  <span class="mf">232.89303</span> <span class="o">+/-</span> <span class="mf">8.0553391</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">250.00000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.100</span><span class="p">)</span>
  <span class="n">amp</span><span class="p">,</span> <span class="n">theta</span>           <span class="o">=</span> <span class="o">-</span><span class="mf">0.854</span>
  <span class="n">del_e0</span><span class="p">,</span> <span class="n">dr_off</span>       <span class="o">=</span>  <span class="mf">0.799</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">dr_off</span>        <span class="o">=</span> <span class="o">-</span><span class="mf">0.380</span>
  <span class="n">alpha</span><span class="p">,</span> <span class="n">del_e0</span>        <span class="o">=</span>  <span class="mf">0.107</span>
 
<span class="p">[[</span><span class="n">Dataset</span> <span class="mi">1</span> <span class="n">of</span> <span class="mi">3</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;dzhvfzs6&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.400</span><span class="p">,</span> <span class="mf">3.400</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">3.000</span><span class="p">,</span> <span class="mf">17.000</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">4.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0011445</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">9.5328e-4</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0384678</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">18.825</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p3tf6mewg&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0001</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.5478000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">12.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.8884690</span> <span class="o">+/-</span> <span class="mf">0.0307237</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.3732949</span> <span class="o">+/-</span> <span class="mf">0.6134197</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.5476294</span> <span class="o">+/-</span> <span class="mf">0.0026594</span>  <span class="o">:=</span> <span class="s1">&#39;reff + dr_off + 10*alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.7063e-4</span> <span class="o">+/-</span> <span class="mf">0.0026594</span>  <span class="o">:=</span> <span class="s1">&#39;dr_off + 10*alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0032777</span> <span class="o">+/-</span> <span class="mf">1.1337e-4</span>  <span class="o">:=</span> <span class="s1">&#39;sigma2_eins(10, theta)&#39;</span>

<span class="p">[[</span><span class="n">Dataset</span> <span class="mi">2</span> <span class="n">of</span> <span class="mi">3</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;de4mv6pn&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.400</span><span class="p">,</span> <span class="mf">3.400</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">3.000</span><span class="p">,</span> <span class="mf">17.000</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">4.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0010793</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0010405</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0362771</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">18.825</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p3tf6mewg&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0001</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.5478000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">12.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.8884690</span> <span class="o">+/-</span> <span class="mf">0.0307237</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.3732949</span> <span class="o">+/-</span> <span class="mf">0.6134197</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.5481690</span> <span class="o">+/-</span> <span class="mf">0.0025219</span>  <span class="o">:=</span> <span class="s1">&#39;reff + dr_off + 50*alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">3.6899e-4</span> <span class="o">+/-</span> <span class="mf">0.0025219</span>  <span class="o">:=</span> <span class="s1">&#39;dr_off + 50*alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0033405</span> <span class="o">+/-</span> <span class="mf">1.2575e-4</span>  <span class="o">:=</span> <span class="s1">&#39;sigma2_eins(50, theta)&#39;</span>

<span class="p">[[</span><span class="n">Dataset</span> <span class="mi">3</span> <span class="n">of</span> <span class="mi">3</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;durzhxyo&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.400</span><span class="p">,</span> <span class="mf">3.400</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">3.000</span><span class="p">,</span> <span class="mf">17.000</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">4.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff0001.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">7.3125e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0013139</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0245778</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">18.825</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p3tf6mewg&#39;</span> <span class="o">=</span> <span class="n">Cu</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff0001</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Cu</span>       <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8016</span><span class="p">,</span>  <span class="mf">1.8016</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.5478000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">12.000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">0.8884690</span> <span class="o">+/-</span> <span class="mf">0.0307237</span>  <span class="o">:=</span> <span class="s1">&#39;amp&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span>  <span class="mf">5.3732949</span> <span class="o">+/-</span> <span class="mf">0.6134197</span>  <span class="o">:=</span> <span class="s1">&#39;del_e0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.5495180</span> <span class="o">+/-</span> <span class="mf">0.0029344</span>  <span class="o">:=</span> <span class="s1">&#39;reff + dr_off + 150*alpha*reff&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">0.0017180</span> <span class="o">+/-</span> <span class="mf">0.0029344</span>  <span class="o">:=</span> <span class="s1">&#39;dr_off + 150*alpha*reff&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0050382</span> <span class="o">+/-</span> <span class="mf">2.9419e-4</span>  <span class="o">:=</span> <span class="s1">&#39;sigma2_eins(150, theta)&#39;</span>

<span class="o">=======================================================</span>
</pre></div>
</div>
<p>Note that an uncertainty is estimated for the Path parameters, including
<code class="docutils literal notranslate"><span class="pre">sigma2</span></code>, which is calculated with the <a class="reference internal" href="xafs_feffpaths.html#sigma2_eins" title="sigma2_eins"><code class="xref py py-func docutils literal notranslate"><span class="pre">sigma2_eins()</span></code></a> function.
Such derived uncertainties do reflect the uncertainties and correlations
between variables.  For example, a simplistic evaluation for the standard
error in one of the <code class="docutils literal notranslate"><span class="pre">sigma2</span></code> parameters using the estimated variance in
the <code class="docutils literal notranslate"><span class="pre">theta</span></code> might be done as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">larch</span><span class="o">&gt;</span> <span class="n">_ave</span> <span class="o">=</span> <span class="n">sigma2_eins</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pars</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">_dlo</span> <span class="o">=</span> <span class="n">sigma2_eins</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pars</span><span class="o">.</span><span class="n">theta</span><span class="o">-</span><span class="n">pars</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span> <span class="o">-</span> <span class="n">_ave</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">_dhi</span> <span class="o">=</span> <span class="n">sigma2_eins</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">pars</span><span class="o">.</span><span class="n">theta</span><span class="o">+</span><span class="n">pars</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span> <span class="o">-</span> <span class="n">_ave</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="nb">print</span> <span class="s2">&quot;sigma2(T=10) = </span><span class="si">%.5f</span><span class="s2">  (</span><span class="si">%+.5f</span><span class="s2">, </span><span class="si">%+.5f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ave</span><span class="p">,</span> <span class="n">_dlo</span><span class="p">,</span> <span class="n">_dhi</span><span class="p">)</span>
<span class="n">sigma2</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.00328</span>  <span class="p">(</span><span class="o">+</span><span class="mf">0.00011</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00011</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives an estimate about 3 times larger than the estimate automatically
derived from the fit.  The reason for this is that the simple evaluation
ignores the correlation between parameters, which is taken into account in
the automatically derived uncertainties.  In this case, including this
correlation significantly reduces the estimated uncertainty.</p>
<p>The output plots for the fits to the three datasets are given below.</p>
<div class="figure compound align-center" id="fig-feffit3temps">
<figure class="align-default" id="id5">
<span id="fig-feffit3temp10k"></span><a class="reference external image-reference" href="_images/feffit_3temp1.png"><img alt="_images/feffit_3temp1.png" src="_images/feffit_3temp1.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.1 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(k)\)</span> at 10 K</span><a class="headerlink" href="#id5" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id6">
<span id="fig-feffit3temp50k"></span><a class="reference external image-reference" href="_images/feffit_3temp3.png"><img alt="_images/feffit_3temp3.png" src="_images/feffit_3temp3.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.2 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(k)\)</span> at 50 K</span><a class="headerlink" href="#id6" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id7">
<span id="fig-feffit3temp150k"></span><a class="reference external image-reference" href="_images/feffit_3temp5.png"><img alt="_images/feffit_3temp5.png" src="_images/feffit_3temp5.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.3 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(k)\)</span> at 150 K</span><a class="headerlink" href="#id7" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id8">
<span id="fig-feffit3temp10r"></span><a class="reference external image-reference" href="_images/feffit_3temp2.png"><img alt="_images/feffit_3temp2.png" src="_images/feffit_3temp2.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.4 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(R)\)</span> at 10 K</span><a class="headerlink" href="#id8" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id9">
<span id="fig-feffit3temp50r"></span><a class="reference external image-reference" href="_images/feffit_3temp4.png"><img alt="_images/feffit_3temp4.png" src="_images/feffit_3temp4.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.5 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(R)\)</span> at 50 K</span><a class="headerlink" href="#id9" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id10">
<span id="fig-feffit3temp150r"></span><a class="reference external image-reference" href="_images/feffit_3temp6.png"><img alt="_images/feffit_3temp6.png" src="_images/feffit_3temp6.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.10.6 </span><span class="caption-text">Fit to Cu <span class="math notranslate nohighlight">\(\chi(R)\)</span> at 150 K</span><a class="headerlink" href="#id10" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><span class="caption-text">Fit to Cu metal at 10 K, 50 K, and 150 K, from simultaneous fit to all
3 datasets with 5 variables used.</span></p>
</div><p id="fig-feffit3temps">Again, in the interest of brevity and consistency through this chapter,
these example are deliberately simple and meant to be illustrative of the
capabilities and procedures and should not be viewed as limiting the types
of problems that can be modeled.</p>
</section>
<section id="example-4-measuring-coordination-number">
<h2><span class="section-number">14.8.11. </span>Example 4: Measuring Coordination number<a class="headerlink" href="#example-4-measuring-coordination-number" title="Link to this heading">¶</a></h2>
<p>For this and the following example, we switch from Cu metal data to data on
a simple metal oxide, FeO.  The structure is a basic rock-salt structure,
and we’ll model 2 paths for Fe-O and Fe-Fe in this structure.  While the
data is imperfect, we’ll use it to illustrate a few points in modeling
EXAFS data.</p>
<p>For the examples above with Cu metal, we tacitly assumed that the
coordination number for the different paths was correct, and we adjusted an
<span class="math notranslate nohighlight">\(S_0^2\)</span> parameter.  But, as with many analyses on real systems of
research interest, we’d like to fit the coordination number for the two
different paths here.  To do this, we set an <span class="math notranslate nohighlight">\(S_0^2\)</span> parameter to a
fixed value, and also force <code class="docutils literal notranslate"><span class="pre">degen</span></code> (the number of equivalent paths in
the structure used to generate the Feff.dat files) to be 1 for each path.
Instead, we’ll define parameters <code class="docutils literal notranslate"><span class="pre">n1</span></code> and <code class="docutils literal notranslate"><span class="pre">n2</span></code>, and set the Fe-O path’s
amplitude to be <code class="docutils literal notranslate"><span class="pre">s02*n1</span></code> and the Fe-Fe path’s amplitude to be <code class="docutils literal notranslate"><span class="pre">s02*n2</span></code>.
We’ll allow <code class="docutils literal notranslate"><span class="pre">n1</span></code> and <code class="docutils literal notranslate"><span class="pre">n2</span></code> to vary in the fit, and also define variable
parameters for the other path parameters, including separate variables for
<span class="math notranslate nohighlight">\(\Delta R\)</span> and <span class="math notranslate nohighlight">\(\sigma^2\)</span>.  The script for this fit is below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/feffit/doc_feffit4.lar</span>

<span class="n">feo_dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/feo_xafs.dat&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy mu&#39;</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">feo_dat</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="c1"># define fitting parameter group</span>
<span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">n1</span>     <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">n2</span>     <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">s02</span>    <span class="o">=</span> <span class="mf">0.700</span><span class="p">,</span>
             <span class="n">de0</span>    <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
             <span class="n">sig2_1</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">delr_1</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span>
             <span class="n">sig2_2</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
             <span class="n">delr_2</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>  <span class="p">)</span>

<span class="c1"># define Feff Paths, give expressions for Path Parameters</span>
<span class="n">path_feo</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span>
                    <span class="n">degen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">s02</span>    <span class="o">=</span> <span class="s1">&#39;s02*n1&#39;</span><span class="p">,</span>
                    <span class="n">e0</span>     <span class="o">=</span> <span class="s1">&#39;de0&#39;</span><span class="p">,</span>
                    <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2_1&#39;</span><span class="p">,</span>
                    <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;delr_1&#39;</span><span class="p">)</span>

<span class="n">path_fefe</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">,</span>
                     <span class="n">degen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">s02</span>    <span class="o">=</span> <span class="s1">&#39;s02*n2&#39;</span><span class="p">,</span>
                     <span class="n">e0</span>     <span class="o">=</span> <span class="s1">&#39;de0&#39;</span><span class="p">,</span>
                     <span class="n">sigma2</span> <span class="o">=</span> <span class="s1">&#39;sig2_2&#39;</span><span class="p">,</span>
                     <span class="n">deltar</span> <span class="o">=</span> <span class="s1">&#39;delr_2&#39;</span><span class="p">)</span>

<span class="c1"># set tranform / fit ranges</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">kmin</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mf">13.5</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">dk</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="n">window</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span>
                         <span class="n">rmin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.2</span><span class="p">,</span> <span class="n">fitspace</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1"># define dataset to include data, pathlist, transform</span>
<span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">feo_dat</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="p">[</span><span class="n">path_feo</span><span class="p">,</span> <span class="n">path_fefe</span><span class="p">],</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
<span class="n">run</span><span class="p">(</span><span class="s1">&#39;doc_macros.lar&#39;</span><span class="p">)</span>
<span class="n">write_report</span><span class="p">(</span><span class="s1">&#39;doc_feffit4.out&#39;</span><span class="p">,</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

<span class="n">plot_chifit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Two-path fit to FeO&#39;</span><span class="p">)</span>
<span class="c1">## end examples/feffit/doc_feffit4.lar</span>
</pre></div>
</div>
<p>The most important point here is the definitions used in setting up the
amplitudes for the paths:  first, that we set <code class="docutils literal notranslate"><span class="pre">degen</span></code> to 1, and second
that we used the expression <code class="docutils literal notranslate"><span class="pre">s02*n1</span></code> and so forth for the value of the
Path’s amplitude.   A secondary note is that we gave two different
k-weights to <a class="reference internal" href="#feffit_transform" title="feffit_transform"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit_transform()</span></code></a>, which causes both k-weights to be
used in the fit.</p>
<p>The resulting output is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">65</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">144</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.1064802</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">64.9851682</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">6.43004950</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.01751179</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">36.8320484</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">42.7082499</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">de0</span>                  <span class="o">=</span> <span class="o">-</span><span class="mf">1.4741655</span> <span class="o">+/-</span> <span class="mf">1.1341834</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.1000000</span><span class="p">)</span>
  <span class="n">delr_1</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">0.0293664</span> <span class="o">+/-</span> <span class="mf">0.0107585</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">delr_2</span>               <span class="o">=</span>  <span class="mf">0.0478234</span> <span class="o">+/-</span> <span class="mf">0.0083873</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">n1</span>                   <span class="o">=</span>  <span class="mf">5.5267534</span> <span class="o">+/-</span> <span class="mf">1.2499525</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">6.0000000</span><span class="p">)</span>
  <span class="n">n2</span>                   <span class="o">=</span>  <span class="mf">11.407633</span> <span class="o">+/-</span> <span class="mf">1.5333836</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">12.000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0120204</span> <span class="o">+/-</span> <span class="mf">0.0027069</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0125357</span> <span class="o">+/-</span> <span class="mf">0.0011737</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.100</span><span class="p">)</span>
  <span class="n">n2</span><span class="p">,</span> <span class="n">sig2_2</span>           <span class="o">=</span>  <span class="mf">0.939</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_2</span>          <span class="o">=</span>  <span class="mf">0.919</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">sig2_1</span>           <span class="o">=</span>  <span class="mf">0.897</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_1</span>          <span class="o">=</span>  <span class="mf">0.582</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">delr_2</span>       <span class="o">=</span>  <span class="mf">0.539</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">sig2_1</span>       <span class="o">=</span>  <span class="mf">0.220</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">n1</span>           <span class="o">=</span>  <span class="mf">0.190</span>
  <span class="n">delr_2</span><span class="p">,</span> <span class="n">sig2_2</span>       <span class="o">=</span>  <span class="mf">0.184</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">n1</span>              <span class="o">=</span> <span class="o">-</span><span class="mf">0.178</span>
  <span class="n">delr_2</span><span class="p">,</span> <span class="n">n2</span>           <span class="o">=</span>  <span class="mf">0.159</span>
  <span class="n">delr_2</span><span class="p">,</span> <span class="n">n1</span>           <span class="o">=</span> <span class="o">-</span><span class="mf">0.156</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">sig2_1</span>          <span class="o">=</span> <span class="o">-</span><span class="mf">0.125</span>
  <span class="n">delr_2</span><span class="p">,</span> <span class="n">sig2_1</span>       <span class="o">=</span> <span class="o">-</span><span class="mf">0.107</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span>               <span class="o">=</span>  <span class="mf">0.106</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;da77uds7&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">3.200</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">2.000</span><span class="p">,</span> <span class="mf">13.500</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">3</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">7.7074e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0018654</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.1661149</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.106</span>
 
<span class="p">[[</span><span class="n">Paths</span><span class="p">]]</span>
 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;pjuumtmhe&#39;</span> <span class="o">=</span> <span class="n">Fe</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff_feo01</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Fe</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
               <span class="n">O</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">2.1387</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">1</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">2.1387000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">1.0000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">3.8687274</span> <span class="o">+/-</span> <span class="mf">0.8749668</span>  <span class="o">:=</span> <span class="s1">&#39;s02*n1&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span> <span class="o">-</span><span class="mf">1.4741655</span> <span class="o">+/-</span> <span class="mf">1.1341834</span>  <span class="o">:=</span> <span class="s1">&#39;de0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">2.1093336</span> <span class="o">+/-</span> <span class="mf">0.0107585</span>  <span class="o">:=</span> <span class="s1">&#39;reff + delr_1&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0293664</span> <span class="o">+/-</span> <span class="mf">0.0107585</span>  <span class="o">:=</span> <span class="s1">&#39;delr_1&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0120204</span> <span class="o">+/-</span> <span class="mf">0.0027069</span>  <span class="o">:=</span> <span class="s1">&#39;sig2_1&#39;</span>

 <span class="o">=</span> <span class="n">Path</span> <span class="s1">&#39;p7etnrdqr&#39;</span> <span class="o">=</span> <span class="n">Fe</span> <span class="n">K</span> <span class="n">Edge</span>
    <span class="n">feffdat</span> <span class="n">file</span> <span class="o">=</span> <span class="n">feff_feo02</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">feff</span> <span class="n">run</span> <span class="s1">&#39;&#39;</span>
    <span class="n">geometry</span>  <span class="n">atom</span>      <span class="n">x</span>        <span class="n">y</span>        <span class="n">z</span>      <span class="n">ipot</span>
              <span class="n">Fe</span>       <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span>  <span class="mf">0.0000</span>  <span class="mi">0</span> <span class="p">(</span><span class="n">absorber</span><span class="p">)</span>
              <span class="n">Fe</span>       <span class="mf">2.1387</span><span class="p">,</span>  <span class="mf">0.0000</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1387</span>  <span class="mi">2</span>
     <span class="n">reff</span>   <span class="o">=</span>  <span class="mf">3.0246000</span>
     <span class="n">degen</span>  <span class="o">=</span>  <span class="mf">1.0000000</span>
     <span class="n">n</span><span class="o">*</span><span class="n">s02</span>  <span class="o">=</span>  <span class="mf">7.9853429</span> <span class="o">+/-</span> <span class="mf">1.0733686</span>  <span class="o">:=</span> <span class="s1">&#39;s02*n2&#39;</span>
     <span class="n">e0</span>     <span class="o">=</span> <span class="o">-</span><span class="mf">1.4741655</span> <span class="o">+/-</span> <span class="mf">1.1341834</span>  <span class="o">:=</span> <span class="s1">&#39;de0&#39;</span>
     <span class="n">r</span>      <span class="o">=</span>  <span class="mf">3.0724234</span> <span class="o">+/-</span> <span class="mf">0.0083873</span>  <span class="o">:=</span> <span class="s1">&#39;reff + delr_2&#39;</span>
     <span class="n">deltar</span> <span class="o">=</span>  <span class="mf">0.0478234</span> <span class="o">+/-</span> <span class="mf">0.0083873</span>  <span class="o">:=</span> <span class="s1">&#39;delr_2&#39;</span>
     <span class="n">sigma2</span> <span class="o">=</span>  <span class="mf">0.0125357</span> <span class="o">+/-</span> <span class="mf">0.0011737</span>  <span class="o">:=</span> <span class="s1">&#39;sig2_2&#39;</span>

<span class="o">=======================================================</span>
</pre></div>
</div>
<p>with plots:</p>
<div class="figure compound align-center" id="fig-feffit-feo">
<figure class="align-default" id="id11">
<span id="fig-feffit-feo-a"></span><a class="reference external image-reference" href="_images/feffit_feo_k.png"><img alt="_images/feffit_feo_k.png" src="_images/feffit_feo_k.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.11.1 </span><span class="caption-text">Fits to 2-path fit to FeO EXAFS, <span class="math notranslate nohighlight">\(k\)</span> space</span><a class="headerlink" href="#id11" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id12">
<span id="fig-feffit-feo-b"></span><a class="reference external image-reference" href="_images/feffit_feo_r.png"><img alt="_images/feffit_feo_r.png" src="_images/feffit_feo_r.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.11.2 </span><span class="caption-text">Fits to 2-path fit to FeO EXAFS, <span class="math notranslate nohighlight">\(R\)</span> space</span><a class="headerlink" href="#id12" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</div></section>
<section id="example-5-comparing-fits-in-different-fit-spaces">
<span id="fig-feffit-feo"></span><h2><span class="section-number">14.8.12. </span>Example 5: Comparing Fits in different Fit Spaces<a class="headerlink" href="#example-5-comparing-fits-in-different-fit-spaces" title="Link to this heading">¶</a></h2>
<p>We now turn to comparing fits in unfiltered k-space, R-space, and filter
k-space (or “q space”).  This is partly to illustrate the preference for
using R- or q-space for fitting, and partly to demonstrate how one can run
similar fits and compare the results.  We’ll use the FeO data from the
previous example.</p>
<p>To change fitting models and transform parameters, we’ll make copies of the
parameter groups and dataset groups, make a few changes, and re-run the
fits.  For example, we can change the fitting space with (see
examples/feffit/doc_feffit5.lar):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">larch</span><span class="o">&gt;</span> <span class="n">pars2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>   <span class="c1"># copy parameters</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset2</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>   <span class="c1"># copy dataset</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset2</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">fitspace</span> <span class="o">=</span> <span class="s1">&#39;q&#39;</span>  <span class="c1"># fit in backtransformed k-space</span>
</pre></div>
</div>
<p>Now we can run <a class="reference internal" href="#id0" title="feffit"><code class="xref py py-func docutils literal notranslate"><span class="pre">feffit()</span></code></a> with the new parameter group and Dataset
group, and compare the results either by plotting models from the different
copies of the dataset or by viewing the parameter values and fit statistics
with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">larch</span><span class="o">&gt;</span> <span class="n">out2</span>  <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars2</span><span class="p">,</span> <span class="n">dset2</span><span class="p">)</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="nb">print</span> <span class="s1">&#39;*** R Space ***&#39;</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="nb">print</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">with_paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_correl</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="nb">print</span> <span class="s1">&#39;*** Q Space ***&#39;</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="nb">print</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">with_paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_correl</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>which gives</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">65</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">144</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.1064802</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">64.9851682</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">6.43004950</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.01751179</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">36.8320484</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">42.7082499</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">de0</span>                  <span class="o">=</span> <span class="o">-</span><span class="mf">1.4741655</span> <span class="o">+/-</span> <span class="mf">1.1341834</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.1000000</span><span class="p">)</span>
  <span class="n">delr_1</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">0.0293664</span> <span class="o">+/-</span> <span class="mf">0.0107585</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">delr_2</span>               <span class="o">=</span>  <span class="mf">0.0478234</span> <span class="o">+/-</span> <span class="mf">0.0083873</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">n1</span>                   <span class="o">=</span>  <span class="mf">5.5267534</span> <span class="o">+/-</span> <span class="mf">1.2499525</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">6.0000000</span><span class="p">)</span>
  <span class="n">n2</span>                   <span class="o">=</span>  <span class="mf">11.407633</span> <span class="o">+/-</span> <span class="mf">1.5333836</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">12.000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0120204</span> <span class="o">+/-</span> <span class="mf">0.0027069</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0125357</span> <span class="o">+/-</span> <span class="mf">0.0011737</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.500</span><span class="p">)</span>
  <span class="n">n2</span><span class="p">,</span> <span class="n">sig2_2</span>           <span class="o">=</span>  <span class="mf">0.939</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_2</span>          <span class="o">=</span>  <span class="mf">0.919</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">sig2_1</span>           <span class="o">=</span>  <span class="mf">0.897</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_1</span>          <span class="o">=</span>  <span class="mf">0.582</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">delr_2</span>       <span class="o">=</span>  <span class="mf">0.539</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;da77uds7&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">3.200</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">2.000</span><span class="p">,</span> <span class="mf">13.500</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">3</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">7.7074e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0018654</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.1661149</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.106</span>
<span class="o">=======================================================</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">65</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">230</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.1064802</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">156.348404</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">15.4701142</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.01377419</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">51.8503032</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">57.7265047</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">de0</span>                  <span class="o">=</span> <span class="o">-</span><span class="mf">1.4418399</span> <span class="o">+/-</span> <span class="mf">1.0075979</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.1000000</span><span class="p">)</span>
  <span class="n">delr_1</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">0.0291715</span> <span class="o">+/-</span> <span class="mf">0.0095887</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">delr_2</span>               <span class="o">=</span>  <span class="mf">0.0481107</span> <span class="o">+/-</span> <span class="mf">0.0074656</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">n1</span>                   <span class="o">=</span>  <span class="mf">5.6991167</span> <span class="o">+/-</span> <span class="mf">1.1559886</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">6.0000000</span><span class="p">)</span>
  <span class="n">n2</span>                   <span class="o">=</span>  <span class="mf">11.460975</span> <span class="o">+/-</span> <span class="mf">1.3706924</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">12.000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0123871</span> <span class="o">+/-</span> <span class="mf">0.0024544</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0125804</span> <span class="o">+/-</span> <span class="mf">0.0010458</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.500</span><span class="p">)</span>
  <span class="n">n2</span><span class="p">,</span> <span class="n">sig2_2</span>           <span class="o">=</span>  <span class="mf">0.940</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_2</span>          <span class="o">=</span>  <span class="mf">0.919</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">sig2_1</span>           <span class="o">=</span>  <span class="mf">0.900</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_1</span>          <span class="o">=</span>  <span class="mf">0.585</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">delr_2</span>       <span class="o">=</span>  <span class="mf">0.542</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;da77uds7&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;q&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">3.200</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">2.000</span><span class="p">,</span> <span class="mf">13.500</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">3</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">7.7074e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0018654</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.1661149</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.106</span>
<span class="o">=======================================================</span>
</pre></div>
</div>
<p>We can see that the results are not very different – the best fit values
and uncertainties for the varied parameters are quite close for the fit in
‘R’ space and ‘Q’ space.</p>
<p>Now, we can try the fit in unfiltered ‘K’ space:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">larch</span><span class="o">&gt;</span> <span class="n">pars3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>   <span class="c1"># copy parameters</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset3</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>   <span class="c1"># copy dataset</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset3</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">kweight</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">dset3</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">fitspace</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
<span class="n">larch</span><span class="o">&gt;</span> <span class="n">out3</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars3</span><span class="p">,</span> <span class="n">dset3</span><span class="p">)</span>
<span class="n">larch</span>  <span class="nb">print</span> <span class="n">feffit_report</span><span class="p">(</span><span class="n">out3</span><span class="p">,</span> <span class="n">with_paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_correl</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>(we need to specify only one k-weight for a k-space fit) which gives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">49</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">230</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.1064802</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">7472994.14</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">739425.988</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.14252657</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">236.167828</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">242.044030</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">de0</span>                  <span class="o">=</span> <span class="o">-</span><span class="mf">1.8796930</span> <span class="o">+/-</span> <span class="mf">2.5288417</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.1000000</span><span class="p">)</span>
  <span class="n">delr_1</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">0.0289651</span> <span class="o">+/-</span> <span class="mf">0.0316889</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">delr_2</span>               <span class="o">=</span>  <span class="mf">0.0447213</span> <span class="o">+/-</span> <span class="mf">0.0247359</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">n1</span>                   <span class="o">=</span>  <span class="mf">5.0911303</span> <span class="o">+/-</span> <span class="mf">2.4586464</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">6.0000000</span><span class="p">)</span>
  <span class="n">n2</span>                   <span class="o">=</span>  <span class="mf">12.781266</span> <span class="o">+/-</span> <span class="mf">5.1119625</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">12.000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0104533</span> <span class="o">+/-</span> <span class="mf">0.0077437</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0135407</span> <span class="o">+/-</span> <span class="mf">0.0042583</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.500</span><span class="p">)</span>
  <span class="n">n2</span><span class="p">,</span> <span class="n">sig2_2</span>           <span class="o">=</span>  <span class="mf">0.924</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">sig2_1</span>           <span class="o">=</span>  <span class="mf">0.881</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_2</span>          <span class="o">=</span>  <span class="mf">0.870</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_1</span>          <span class="o">=</span>  <span class="mf">0.671</span>
  <span class="n">delr_1</span><span class="p">,</span> <span class="n">delr_2</span>       <span class="o">=</span>  <span class="mf">0.591</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;da77uds7&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">3.200</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">2.000</span><span class="p">,</span> <span class="mf">13.500</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">8.0580e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0018556</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0152209</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.106</span>
<span class="o">=======================================================</span>
</pre></div>
</div>
<p>This has pretty similar best-fit values, but dramatically larger estimates
of the errors.  The spectrum is really very poorly fit in k-space because
we have not accounted for the higher R components.  Using R (and Q) space,
we’re able to limit the R range used in determining the parameter values,
estimated uncertainties, and the goodness-of-fit statistics.  But since we
can’t place these limits on what portion of the data is being compared to
the model spectra in unfiltered k-space fit, the uncertainties reflect the
fact that the full experimental spectrum is not well model.  This is why it
is recommended to not fit in unfiltered k space: the uncertainties in the
parameters is too large.</p>
<p>Finally, we can also fit simultaneously in ‘k’ and ‘r’ space by making use
of wavelet transforms (see Section <a class="reference internal" href="xafs_wavelets.html#xafs-wavelet-sec"><span class="std std-ref">XAFS: Wavelet Transforms for XAFS</span></a>).  For this, we
specify both k and R ranges, and the fit is done on the wavelet
transform. This gives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===================</span> <span class="n">FEFFIT</span> <span class="n">RESULTS</span> <span class="o">====================</span>
<span class="p">[[</span><span class="n">Statistics</span><span class="p">]]</span>
  <span class="n">n_function_calls</span>     <span class="o">=</span> <span class="mi">57</span>
  <span class="n">n_variables</span>          <span class="o">=</span> <span class="mi">7</span>
  <span class="n">n_data_points</span>        <span class="o">=</span> <span class="mi">33120</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.1064802</span>
  <span class="n">chi_square</span>           <span class="o">=</span> <span class="mf">821.617284</span>
  <span class="n">reduced</span> <span class="n">chi_square</span>   <span class="o">=</span> <span class="mf">81.2960857</span>
  <span class="n">r</span><span class="o">-</span><span class="n">factor</span>             <span class="o">=</span> <span class="mf">0.00997058</span>
  <span class="n">Akaike</span> <span class="n">info</span> <span class="n">crit</span>     <span class="o">=</span> <span class="mf">80.2331669</span>
  <span class="n">Bayesian</span> <span class="n">info</span> <span class="n">crit</span>   <span class="o">=</span> <span class="mf">86.1093683</span>
 
<span class="p">[[</span><span class="n">Variables</span><span class="p">]]</span>
  <span class="n">de0</span>                  <span class="o">=</span> <span class="o">-</span><span class="mf">1.9314719</span> <span class="o">+/-</span> <span class="mf">0.8311485</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.1000000</span><span class="p">)</span>
  <span class="n">delr_1</span>               <span class="o">=</span> <span class="o">-</span><span class="mf">0.0304702</span> <span class="o">+/-</span> <span class="mf">0.0088736</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">delr_2</span>               <span class="o">=</span>  <span class="mf">0.0444351</span> <span class="o">+/-</span> <span class="mf">0.0069502</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0000000</span><span class="p">)</span>
  <span class="n">n1</span>                   <span class="o">=</span>  <span class="mf">6.0513190</span> <span class="o">+/-</span> <span class="mf">1.2911656</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">6.0000000</span><span class="p">)</span>
  <span class="n">n2</span>                   <span class="o">=</span>  <span class="mf">12.171926</span> <span class="o">+/-</span> <span class="mf">1.2495291</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">12.000000</span><span class="p">)</span>
  <span class="n">sig2_1</span>               <span class="o">=</span>  <span class="mf">0.0131212</span> <span class="o">+/-</span> <span class="mf">0.0029093</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
  <span class="n">sig2_2</span>               <span class="o">=</span>  <span class="mf">0.0131444</span> <span class="o">+/-</span> <span class="mf">0.0010217</span>  <span class="p">(</span><span class="n">init</span><span class="o">=</span> <span class="mf">0.0020000</span><span class="p">)</span>
 
<span class="p">[[</span><span class="n">Correlations</span><span class="p">]]</span> <span class="p">(</span><span class="n">unreported</span> <span class="n">correlations</span> <span class="n">are</span> <span class="o">&lt;</span>  <span class="mf">0.500</span><span class="p">)</span>
  <span class="n">n2</span><span class="p">,</span> <span class="n">sig2_2</span>           <span class="o">=</span>  <span class="mf">0.944</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_2</span>          <span class="o">=</span>  <span class="mf">0.928</span>
  <span class="n">n1</span><span class="p">,</span> <span class="n">sig2_1</span>           <span class="o">=</span>  <span class="mf">0.917</span>
  <span class="n">de0</span><span class="p">,</span> <span class="n">delr_1</span>          <span class="o">=</span>  <span class="mf">0.519</span>
 
<span class="p">[[</span><span class="n">Dataset</span><span class="p">]]</span>
  <span class="n">unique_id</span>            <span class="o">=</span> <span class="s1">&#39;da77uds7&#39;</span>
  <span class="n">fit</span> <span class="n">space</span>            <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
  <span class="n">r</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">3.200</span>
  <span class="n">k</span><span class="o">-</span><span class="nb">range</span>              <span class="o">=</span> <span class="mf">2.000</span><span class="p">,</span> <span class="mf">13.500</span>
  <span class="n">k</span> <span class="n">window</span><span class="p">,</span> <span class="n">dk</span>         <span class="o">=</span> <span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="mf">3.000</span>
  <span class="n">paths</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">fit</span>    <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feff_feo01.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;feff_feo02.dat&#39;</span><span class="p">]</span>
  <span class="n">k</span><span class="o">-</span><span class="n">weight</span>             <span class="o">=</span> <span class="mi">2</span>
  <span class="n">epsilon_k</span>            <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">8.0580e-4</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">0.0018556</span><span class="p">)</span>
  <span class="n">epsilon_r</span>            <span class="o">=</span> <span class="mf">0.0152209</span>
  <span class="n">n_independent</span>        <span class="o">=</span> <span class="mf">17.106</span>
<span class="o">=======================================================</span>
</pre></div>
</div>
<p>As you can see, the results are all pretty similar.</p>
<p>Of course, for all these examples, we’ve changed only one thing between
these fits – the fitting ‘space’.  The process of copying the parameter
group and dataset, making modifications and re-doing fits can also include
changing what parametres are varied, and what constraints are placed
between parameters.</p>
</section>
<section id="example-6-testing-exafs-sensitivity-to-z">
<h2><span class="section-number">14.8.13. </span>Example 6: Testing EXAFS sensitivity to <span class="math notranslate nohighlight">\(Z\)</span><a class="headerlink" href="#example-6-testing-exafs-sensitivity-to-z" title="Link to this heading">¶</a></h2>
<p id="index-3">EXAFS is known to be sensitive to the atomic number <span class="math notranslate nohighlight">\(Z\)</span> of the
scattering atom.  This is due to the <span class="math notranslate nohighlight">\(Z\)</span> dependence of the scattering
amplitude and phase shift (<span class="math notranslate nohighlight">\(f(k)\)</span> and <span class="math notranslate nohighlight">\(\delta(k)\)</span> in the EXAFS
Equation of Section <a class="reference internal" href="xafs_feffpaths.html#xafs-exafsequation-sec"><span class="std std-ref">The EXAFS Equation using Feff and FeffPath Groups</span></a>).  A rule-of-thumb that
is often stated is that EXAFS is sensitive to <span class="math notranslate nohighlight">\(Z \pm 5\)</span>, or perhaps
pessimistically to <em>row of the Periodic Table</em>, but not as sensitive as
<span class="math notranslate nohighlight">\(Z \pm 1\)</span>.  Occassionally, you may see work that claims very fine
<span class="math notranslate nohighlight">\(Z\)</span> sensitivity, such as being able to distinguish N and O ligands.
In those works, XAFS results are typically used with chemical arguments
about steric effects or known bond distances.</p>
<p id="index-4">In this section, we’ll explore the <span class="math notranslate nohighlight">\(Z\)</span> sensitivity of XAFS with real
data, by constructing Feff paths with different scatterers and trying to
fit data with these different scattering paths.  This makes a nice exercise
in how to manipulate Feff, how to fit XAFS data, and how to compare XAFS
fits.  Just to make it a little more complicated, we’ll also explore the
idea of <strong>Phase corrected</strong> Fourier transforms and how they might be used
to better determine both <span class="math notranslate nohighlight">\(R\)</span> and <span class="math notranslate nohighlight">\(Z\)</span>.  The example script here
is a little more complex than what we’ve seen above, using many feature of
the Larch scripting language to do repeated fits and mathematically
manipulating the arrays of data.</p>
<figure class="align-center" id="id13">
<span id="fig-znse-xafs"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Data.png"><img alt="_images/Feffit_ZnSe_Data.png" src="_images/Feffit_ZnSe_Data.png" style="width: 65%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.1 </span><span class="caption-text">Zn K-edge XAFS data for ZnSe.</span><a class="headerlink" href="#id13" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>For this example, we’ll use Zn K-edge data of ZnSe, with <span class="math notranslate nohighlight">\(\chi(k)\)</span>
data shown in <a class="reference internal" href="#fig-znse-xafs"><span class="std std-numref">Figure 14.8.13.1</span></a>.  The data is pretty good but not
perfect, and is useful for the study here mainly because the structure is
simple, with a well-isolated and well-ordered shell of scatterers (the
cubic ZnS structure with 1 Zn site surrounded by 4 Se at 2.45
<span class="math notranslate nohighlight">\(\rm\AA\)</span>).  While we’re sure that the scatterer <em>should</em> be Se, we’ll
try scatterers of Zn, Ge, Se, Br, and Rb, spanning a small but sufficient
range of <span class="math notranslate nohighlight">\(Z\)</span>.</p>
<p>To construct the scattering paths, we’ll modify a Feff input file.  To do
this, we start with a feff.inp file generated for crystalline ZnSe by the
ATOMS program, and add an IPOT to the list of atomic potentials (here the
line <code class="docutils literal notranslate"><span class="pre">3</span>&#160;&#160;&#160; <span class="pre">35</span>&#160;&#160;&#160; <span class="pre">Br</span></code>), and then replace the IPOTs for 1 of the neighboring Se
atoms (that is, replacing a 2 with a 3, and changing the tag for
convenience).  The resulting feff.inp file for Br looks this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
 <span class="n">TITLE</span>  <span class="n">ZnSe</span> <span class="p">(</span><span class="n">cubic</span> <span class="n">zinc</span> <span class="n">sulfide</span> <span class="n">structure</span><span class="p">)</span>
 <span class="n">HOLE</span> <span class="mi">1</span>   <span class="mf">1.0</span>   <span class="o">*</span>  <span class="n">Zn</span> <span class="n">K</span> <span class="n">edge</span>  <span class="p">(</span><span class="mf">9659.0</span> <span class="n">eV</span><span class="p">),</span> <span class="n">second</span> <span class="n">number</span> <span class="ow">is</span> <span class="n">S0</span><span class="o">^</span><span class="mi">2</span>

 <span class="n">CONTROL</span>   <span class="mi">1</span>      <span class="mi">1</span>     <span class="mi">1</span>     <span class="mi">1</span>
 <span class="n">PRINT</span>     <span class="mi">1</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
 <span class="n">RMAX</span>      <span class="mf">6.0</span>
 <span class="n">NLEG</span>      <span class="mi">4</span>

 <span class="n">POTENTIALS</span>
 <span class="o">*</span>    <span class="n">ipot</span>   <span class="n">Z</span>  <span class="n">element</span>
        <span class="mi">0</span>   <span class="mi">30</span>   <span class="n">Zn</span>
        <span class="mi">1</span>   <span class="mi">30</span>   <span class="n">Zn</span>
        <span class="mi">2</span>   <span class="mi">34</span>   <span class="n">Se</span>
        <span class="mi">3</span>   <span class="mi">36</span>   <span class="n">Kr</span>
      <span class="c1"># 3   33   As</span>
      <span class="c1"># 3   32   Ge</span>
      <span class="c1"># 3   31   Ga</span>

 <span class="n">ATOMS</span>                          <span class="o">*</span> <span class="n">this</span> <span class="nb">list</span> <span class="n">contains</span> <span class="mi">35</span> <span class="n">atoms</span>
 <span class="o">*</span>   <span class="n">x</span>          <span class="n">y</span>          <span class="n">z</span>      <span class="n">ipot</span>  <span class="n">tag</span>              <span class="n">distance</span>
    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>  <span class="mi">0</span> <span class="n">Zn1</span>             <span class="mf">0.00000</span>
    <span class="mf">1.41690</span>    <span class="mf">1.41690</span>    <span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_1</span>           <span class="mf">2.45414</span>
   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">1.41690</span>  <span class="mi">3</span> <span class="n">Br_1</span>            <span class="mf">2.45414</span>
   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_1</span>           <span class="mf">2.45414</span>
    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_1</span>           <span class="mf">2.45414</span>
    <span class="mf">2.83380</span>    <span class="mf">2.83380</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">2.83380</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">2.83380</span>   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
   <span class="o">-</span><span class="mf">2.83380</span>   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">2.83380</span>    <span class="mf">0.00000</span>    <span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">0.00000</span>    <span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">0.00000</span>    <span class="mf">2.83380</span>    <span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">2.83380</span>    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
   <span class="o">-</span><span class="mf">2.83380</span>    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">0.00000</span>    <span class="mf">2.83380</span>   <span class="o">-</span><span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">2.83380</span>   <span class="o">-</span><span class="mf">2.83380</span>  <span class="mi">1</span> <span class="n">Zn1_1</span>           <span class="mf">4.00760</span>
   <span class="o">-</span><span class="mf">4.25070</span>    <span class="mf">1.41690</span>    <span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">4.25070</span>    <span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">4.25070</span>   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">4.25070</span>    <span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">1.41690</span>    <span class="mf">4.25070</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>    <span class="mf">4.25070</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">4.25070</span>    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">1.41690</span>    <span class="mf">4.25070</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
   <span class="o">-</span><span class="mf">4.25070</span>   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">4.25070</span>   <span class="o">-</span><span class="mf">1.41690</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">1.41690</span>    <span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">4.25070</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">1.41690</span>   <span class="o">-</span><span class="mf">4.25070</span>  <span class="mi">2</span> <span class="n">Se1_2</span>           <span class="mf">4.69933</span>
    <span class="mf">5.66760</span>    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
   <span class="o">-</span><span class="mf">5.66760</span>    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
    <span class="mf">0.00000</span>    <span class="mf">5.66760</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">5.66760</span>    <span class="mf">0.00000</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>    <span class="mf">5.66760</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
    <span class="mf">0.00000</span>    <span class="mf">0.00000</span>   <span class="o">-</span><span class="mf">5.66760</span>  <span class="mi">1</span> <span class="n">Zn1_2</span>           <span class="mf">5.66760</span>
 <span class="n">END</span>
</pre></div>
</div>
<p>Afer running feff.inp, we collect the resulting <code class="docutils literal notranslate"><span class="pre">feffNNNN.dat</span></code> files –
either <code class="docutils literal notranslate"><span class="pre">feff0001.dat</span></code> or <code class="docutils literal notranslate"><span class="pre">feff0002.dat</span></code> will have the replaced scatterer,
the other will have Se as the scatterer.   Once we’ve collected all these
files for runs of Feff with feff.inp altered for each scatterer, we’re ready
to do the fits.</p>
<p>The script to compare the fits will loop over these different scattering
paths, doing a fit for each path, and store the results.  This takes
advantage of several features of the Larch scripting capabilities,
including defining functions, and constructs like loops and dictionaries,
as well as mathematical manipulation of the resulting arrays for the phase
correction.  The full script is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/feffit/doc_feffit6.lar</span>

<span class="c1"># Testing sensitivity to Z of backscatterer, and</span>
<span class="c1"># how well &quot;phase corrected&quot; Fourier transforms predict distance</span>

<span class="k">def</span> <span class="nf">get_zinc_mu</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy dwelltime i0 i1&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;read raw data, do background subtraction&quot;&quot;&quot;</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">dat</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">ln</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">i1</span> <span class="o">/</span> <span class="n">dat</span><span class="o">.</span><span class="n">i0</span><span class="p">)</span>
    <span class="n">autobk</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">e0</span> <span class="o">=</span> <span class="mf">9666.0</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dat</span>
<span class="c1">#enddef</span>

<span class="k">def</span> <span class="nf">plot_chidata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">kopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$k \rm\,(\AA^{-1})$&#39;</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$k^2\chi(k) \rm\,(\AA^{-2})$&#39;</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">chi</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">kopts</span><span class="p">)</span>
<span class="c1">#enddef</span>

<span class="k">def</span> <span class="nf">rplot_fit</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;make R-spae plots of results&quot;</span>
    <span class="n">ropts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$R \rm\,(\AA)$&#39;</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$|\chi(R)| \rm\,(\AA^{-3})$&#39;</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>  <span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">ropts</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>  <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_mag</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Feff Path&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>

    <span class="n">chir_pha</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_phcor</span>
    <span class="n">chir_pha_mag</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">chir_pha</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chir_pha</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>  <span class="n">chir_pha_mag</span><span class="p">,</span>  <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;phase-corrected data&#39;</span><span class="p">)</span>

    <span class="c1"># find region around peak in phase-corrected chi(R)</span>

    <span class="n">irmax</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">chir_pha_mag</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">chir_pha_mag</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">irmax</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">irmax</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_im</span><span class="p">[</span><span class="n">irmax</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">irmax</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;short dashed&#39;</span><span class="p">,</span>
         <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Im[phase-corrected]&#39;</span><span class="p">)</span>
    <span class="k">return</span>
<span class="c1">#enddef</span>

<span class="k">def</span> <span class="nf">phase_correct</span><span class="p">(</span><span class="n">dset</span><span class="p">):</span>
   <span class="s2">&quot;calculate phase-corrected FT, find estimate of R&quot;</span>
   <span class="n">nrpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
   <span class="n">path1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">paths</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
   <span class="c1"># get phase from Feff path</span>
   <span class="n">feff_pha</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">path1</span><span class="o">.</span><span class="n">_feffdat</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">path1</span><span class="o">.</span><span class="n">_feffdat</span><span class="o">.</span><span class="n">pha</span><span class="p">,</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
   <span class="c1"># phase-corrected Fourier Transform</span>
   <span class="n">chir_pha</span> <span class="o">=</span> <span class="n">xftf_fast</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">chi</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">feff_pha</span><span class="p">)</span> <span class="o">*</span>
                        <span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">kwin</span> <span class="o">*</span> <span class="n">dset</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">)[:</span><span class="n">nrpts</span><span class="p">]</span>
   <span class="n">chir_pha_mag</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">chir_pha</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">chir_pha</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
   <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_phcor</span> <span class="o">=</span> <span class="n">chir_pha</span>

   <span class="c1"># find region around peak in phase-corrected chi(R)</span>
   <span class="n">irmax</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">chir_pha_mag</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">chir_pha_mag</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">irmax</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">irmax</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">chir_im</span><span class="p">[</span><span class="n">irmax</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">irmax</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
   <span class="c1"># find where Im[chi(R)_phase_corrected] = 0: use linear regression</span>
   <span class="n">o</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
   <span class="n">dset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rphcor</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
   <span class="k">return</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="c1">#enddef</span>

<span class="c1">###################################################</span>
<span class="n">znse_data</span> <span class="o">=</span> <span class="n">get_zinc_mu</span><span class="p">(</span><span class="s1">&#39;../xafsdata/znse_zn_xafs.001&#39;</span><span class="p">,</span>
                        <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy dwelltime i0 i1&#39;</span><span class="p">)</span>

<span class="c1"># plot_chidata(znse_data, &#39;Zn K-edge ZnSe&#39;)</span>

<span class="c1"># define Feff Paths, storing them in dictionary</span>
<span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">pathargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">degen</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">s02</span><span class="o">=</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="s1">&#39;del_e0&#39;</span><span class="p">,</span> <span class="n">sigma2</span><span class="o">=</span><span class="s1">&#39;sig2&#39;</span><span class="p">,</span> <span class="n">deltar</span><span class="o">=</span><span class="s1">&#39;del_r&#39;</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Zn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znzn.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Ga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znga.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Ge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znge.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;As&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znas.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znse.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znbr.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Kr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znkr.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>
<span class="n">paths</span><span class="p">[</span><span class="s1">&#39;Rb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feffpath</span><span class="p">(</span><span class="s1">&#39;Feff_ZnSe/feff_znrb.dat&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pathargs</span><span class="p">)</span>

<span class="c1"># set FT tranform and Fit ranges</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">feffit_transform</span><span class="p">(</span><span class="n">rmin</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
                         <span class="n">kw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">)</span>

<span class="c1"># perform fit for each scatterer</span>
<span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;|Scatterer|RedChi2|    S02     |   sigma2      |      E0     |      R       |R_phcor|&#39;</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;|  </span><span class="si">%s</span><span class="s1">     | </span><span class="si">%5.1f</span><span class="s1"> |</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">|</span><span class="si">%s</span><span class="s1">|</span><span class="si">%7.3f</span><span class="s1">|&#39;</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">scatterer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">)):</span>
    <span class="n">dset</span>  <span class="o">=</span> <span class="n">feffit_dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">znse_data</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="p">{</span><span class="n">scatterer</span><span class="p">:</span> <span class="n">paths</span><span class="p">[</span><span class="n">scatterer</span><span class="p">]},</span>
                           <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">amp</span>    <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span>
                 <span class="n">del_e0</span> <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
                 <span class="n">sig2</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="mf">0.006</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                 <span class="n">del_r</span>  <span class="o">=</span> <span class="n">guess</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">feffit</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
    <span class="n">path1</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">scatterer</span><span class="p">]</span>
    <span class="c1"># read scatterer from Feff geometry, to be sure it&#39;s correct</span>
    <span class="n">scatt</span> <span class="o">=</span> <span class="n">path1</span><span class="o">.</span><span class="n">_feffdat</span><span class="o">.</span><span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Path: Zn-</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">scatt</span>
    <span class="n">r_phcor</span> <span class="o">=</span> <span class="n">phase_correct</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rplot_fit</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="n">ix</span><span class="p">)</span>

    <span class="n">redchi</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">chi2_reduced</span>

    <span class="n">_amp</span>   <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%5.2f</span><span class="s1">(</span><span class="si">%.2f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_de0</span>   <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%6.2f</span><span class="s1">(</span><span class="si">%.2f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;del_e0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>  <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;del_e0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_ss2</span>   <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%6.4f</span><span class="s1">(</span><span class="si">%.4f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sig2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>  <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sig2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_r</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%6.3f</span><span class="s1">(</span><span class="si">%.3f</span><span class="s1">) &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path1</span><span class="o">.</span><span class="n">reff</span><span class="o">+</span><span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;del_r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;del_r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">scatt</span><span class="p">,</span> <span class="n">redchi</span><span class="p">,</span> <span class="n">_amp</span><span class="p">,</span> <span class="n">_ss2</span><span class="p">,</span> <span class="n">_de0</span><span class="p">,</span> <span class="n">_r</span><span class="p">,</span> <span class="n">r_phcor</span><span class="p">))</span>
    <span class="n">results</span><span class="p">[</span><span class="n">scatterer</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
<span class="c1">#endfor</span>

<span class="c1">## end examples/feffit/doc_feffit6.lar</span>
</pre></div>
</div>
<p>After reading in the data, the script builds Feff Paths, putting them into
a dictionary.  After define the fitting transform range, the script loops
over each of the scatterers, doing a simple first-shell fit with each.  The
the phase-corrected <span class="math notranslate nohighlight">\(\chi(R)\)</span> is then calculated, and the peak value of
<span class="math notranslate nohighlight">\(R\)</span> is found for this array.  Finally, results are printed out.</p>
<blockquote id="xafs-feffit-znse-results">
<div><blockquote>
<div><p>Table of ZnSe Results.  The results from fitting ZnSe XAFS data to
scattering paths of Zn-Zn, Zn-Ge, Zn-Se, Zn-Br, and Zn-Rb.  All paths
started at the nominal distance of 2.454 <span class="math notranslate nohighlight">\(\rm\AA\)</span>.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Scatterer</p></th>
<th class="head"><p>reduced chi-square</p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(S_0^2\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(\sigma^2\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(E_0\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(R\)</span></p></th>
<th class="head"><p><span class="math notranslate nohighlight">\(R_{\rm{ph cor}}\)</span></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Zn (30)</p></td>
<td><p>57.5</p></td>
<td><p>0.73(0.07)</p></td>
<td><p>0.0040(0.0006)</p></td>
<td><p>-7.98(1.23)</p></td>
<td><p>2.471(0.006)</p></td>
<td><p>2.451</p></td>
</tr>
<tr class="row-odd"><td><p>Ge (32)</p></td>
<td><p>32.4</p></td>
<td><p>0.90(0.06)</p></td>
<td><p>0.0050(0.0005)</p></td>
<td><p>-2.99(0.93)</p></td>
<td><p>2.461(0.004)</p></td>
<td><p>2.457</p></td>
</tr>
<tr class="row-even"><td><p>Se (34)</p></td>
<td><p>12.7</p></td>
<td><p>0.89(0.04)</p></td>
<td><p>0.0059(0.0003)</p></td>
<td><p>0.09(0.58)</p></td>
<td><p>2.448(0.003)</p></td>
<td><p>2.461</p></td>
</tr>
<tr class="row-odd"><td><p>Br (35)</p></td>
<td><p>16.7</p></td>
<td><p>1.08(0.06)</p></td>
<td><p>0.0070(0.0004)</p></td>
<td><p>1.71(0.79)</p></td>
<td><p>2.444(0.003)</p></td>
<td><p>2.462</p></td>
</tr>
<tr class="row-even"><td><p>Rb (37)</p></td>
<td><p>88.7</p></td>
<td><p>1.10(0.14)</p></td>
<td><p>0.0073(0.0009)</p></td>
<td><p>5.27(1.42)</p></td>
<td><p>2.425(0.007)</p></td>
<td><p>2.467</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The results of the fits are given in the <a class="reference internal" href="#xafs-feffit-znse-results"><span class="std std-ref">Table of ZnSe Results</span></a>, with graphs below showing fits to the 5
different scatterers.  The dependence of the results on <span class="math notranslate nohighlight">\(Z\)</span> of the
back-scattering atom is seen to be reasonably strong.  The values for reduced
chi-square definitely indicate that Zn-Se is the best fit, and the values for
the fitted parameters have rather clear correlations with <span class="math notranslate nohighlight">\(Z\)</span> –
<span class="math notranslate nohighlight">\(S_0^2\)</span>, <span class="math notranslate nohighlight">\(\sigma^2\)</span>, and <span class="math notranslate nohighlight">\(E_0\)</span> increase with <span class="math notranslate nohighlight">\(Z\)</span>,
while <span class="math notranslate nohighlight">\(R\)</span> decreases.  If anything, the <span class="math notranslate nohighlight">\(Z \pm 5\)</span> rule-of-thumb
seems pessimistic, though the fits with Ge and Br look decent enough that it
would be easy to conclude that <span class="math notranslate nohighlight">\(Z \pm 2\)</span> is reasonable.</p>
<p>As a curious side note, we note that <span class="math notranslate nohighlight">\(S_0^2\)</span> <em>increases</em> with
<span class="math notranslate nohighlight">\(Z\)</span>.  The scattering factor should also increase with <span class="math notranslate nohighlight">\(Z\)</span>, which
might lead us to suspect a trend in the opposite direction.  The confounding
factor here is <span class="math notranslate nohighlight">\(\sigma^2\)</span> – if we fix <span class="math notranslate nohighlight">\(\sigma^2\)</span> to 0.006 (by
changing <code class="docutils literal notranslate"><span class="pre">vary=True</span></code> to <code class="docutils literal notranslate"><span class="pre">vary=False</span></code>) and re-run the fits, <span class="math notranslate nohighlight">\(S_0^2\)</span>
has a slight negative dependence on <span class="math notranslate nohighlight">\(Z\)</span>.</p>
<div class="figure compound align-center" id="fig-feffit-znse2">
<figure class="align-default" id="id14">
<span id="fig-znse-fit-zn"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Zn.png"><img alt="_images/Feffit_ZnSe_Zn.png" src="_images/Feffit_ZnSe_Zn.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.2 </span><span class="caption-text">Fit to ZnSe with Zn back-scatterer</span><a class="headerlink" href="#id14" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id15">
<span id="fig-znse-fit-ge"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Ge.png"><img alt="_images/Feffit_ZnSe_Ge.png" src="_images/Feffit_ZnSe_Ge.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.3 </span><span class="caption-text">Fit to ZnSe with Ge back-scatterer</span><a class="headerlink" href="#id15" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id16">
<span id="fig-znse-fit-se"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Se.png"><img alt="_images/Feffit_ZnSe_Se.png" src="_images/Feffit_ZnSe_Se.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.4 </span><span class="caption-text">Fit to ZnSe with Se back-scatterer</span><a class="headerlink" href="#id16" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id17">
<span id="fig-znse-fit-br"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Br.png"><img alt="_images/Feffit_ZnSe_Br.png" src="_images/Feffit_ZnSe_Br.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.5 </span><span class="caption-text">Fit to ZnSe with Br back-scatterer</span><a class="headerlink" href="#id17" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id18">
<span id="fig-znse-fit-rb"></span><a class="reference external image-reference" href="_images/Feffit_ZnSe_Rb.png"><img alt="_images/Feffit_ZnSe_Rb.png" src="_images/Feffit_ZnSe_Rb.png" style="width: 100%;" />
</a>
<figcaption>
<p><span class="caption-number">Figure 14.8.13.6 </span><span class="caption-text">Fit to ZnSe with Rb back-scatterer</span><a class="headerlink" href="#id18" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<span class="target" id="fig-feffit-znse2"></span></div><p id="index-5">The figures also show <strong>phase-corrected</strong> Fourier transforms using the total
scattering phase from the Feff calculation to correct the data.  This
correction is done in the <code class="docutils literal notranslate"><span class="pre">phase_correct()</span></code> procedure, where the data from
the <em>feffNNNN.dat</em> file (in the <code class="docutils literal notranslate"><span class="pre">_feffdat</span></code> group) is used to construct the
Feff phase shift (<span class="math notranslate nohighlight">\(\delta(k)\)</span> in the EXAFS Equation of Section
<a class="reference internal" href="xafs_feffpaths.html#xafs-exafsequation-sec"><span class="std std-ref">The EXAFS Equation using Feff and FeffPath Groups</span></a>), and apply it to the data.  Because this uses
complex math, we use the <a class="reference internal" href="xafs_fourier.html#xftf_fast" title="xftf_fast"><code class="xref py py-func docutils literal notranslate"><span class="pre">xftf_fast()</span></code></a> function to the complex Fourier
transform and build the magnitude of the transform explicitly.</p>
<p>The phase corrected transforms are shown in black in
<a class="reference internal" href="#fig-znse-fit-zn"><span class="std std-numref">Figure 14.8.13.2</span></a> through <a class="reference internal" href="#fig-znse-fit-rb"><span class="std std-numref">Figure 14.8.13.6</span></a>, and show the
key benefit of these transforms – the peak in the phase corrected
<span class="math notranslate nohighlight">\(\chi(R)\)</span> peaks much closer to an <span class="math notranslate nohighlight">\(R\)</span> that is the bond distance
(for Zn-Se, around 2.45 <span class="math notranslate nohighlight">\(\rm\AA\)</span>), whereas the normal XAFS Fourier
transform peaks much lower.  This suggests a further test on whether the
bond distance and <span class="math notranslate nohighlight">\(Z\)</span> of the scattering atom are correct.  That is,
in order for the phase-correction to give the correct interatomic distance,
the total phase-shift has to be correct, which means that the <span class="math notranslate nohighlight">\(Z\)</span> for
the scatterer has to be correct (see the EXAFS Equation in Section
<a class="reference internal" href="xafs_feffpaths.html#xafs-exafsequation-sec"><span class="std std-ref">The EXAFS Equation using Feff and FeffPath Groups</span></a>).  So, we can compare the refined distance
with the peak in the phase-corrected transform – if they agree, it gives
good confidence that the scatterer is correct.</p>
<p>Since the spacing of points in <span class="math notranslate nohighlight">\(R\)</span> is <span class="math notranslate nohighlight">\(\sim 0.03\rm\AA\)</span>, using
the peak position may not be accurate enough.  Instead, we can use the
value where <span class="math notranslate nohighlight">\(\rm Im[\chi(R)_{\rm{ph cor}}]\)</span> passes through zero (see
dashed lines in <a class="reference internal" href="#fig-znse-fit-zn"><span class="std std-numref">Figure 14.8.13.2</span></a> through
<a class="reference internal" href="#fig-znse-fit-rb"><span class="std std-numref">Figure 14.8.13.6</span></a>).  These values are reported in the <a class="reference internal" href="#xafs-feffit-znse-results"><span class="std std-ref">Table
of ZnSe Results</span></a> as <span class="math notranslate nohighlight">\(R_{\rm{phcor}}\)</span>.</p>
<p>We see an interesting trend that while the refined distance <em>decreases</em> with
<span class="math notranslate nohighlight">\(Z\)</span>, the value for <span class="math notranslate nohighlight">\(R_{\rm{phcor}}\)</span> increases slightly.  The two
values cross between Ge and Se.  This is pretty good agreement, especially
considering we left out the <span class="math notranslate nohighlight">\(\sigma^2\)</span> contribution to phase-shift in
the EXAFS equation from this phase correction, and applied the theoretical
phase-shift from Feff to the measured data.  The <span class="math notranslate nohighlight">\(Z\)</span> dependence of
<span class="math notranslate nohighlight">\(R_{\rm{phcor}}\)</span> is not as strong as the <span class="math notranslate nohighlight">\(Z\)</span> dependence of
reduced chi-square, but this analysis also suggests that one can determine
<span class="math notranslate nohighlight">\(Z \pm 3\)</span>, at least in this rather favorable case.</p>
<p>Again, this is an unusually favorable case – a simple structure with a
single well-isolated coordination shell.  The phase-correction method will
<strong>not</strong> work at all on a mixed coordination shell, and is likely to give
larger errors for a highly-disordered system.  But, for simple,
well-characterized systems, the ability to do such analysis can be very
powerful, and give increased confidence in the refined structure.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="xafs_diffkk.html" title="14.9. XAFS: Computing anomalous scattering factors from XAFS data"
             >next</a> |</li>
        <li class="right" >
          <a href="xafs_feffpaths.html" title="14.7. XAFS: Reading and using Feff Paths"
             >previous</a> |</li>
   <li>[<a href="index.html"> Larch</a>|</li>
   <li><a href="getting_started.html"> Getting Started</a>|</li>
   <li><a href="xafs.html">XAFS Analysis</a>|</li>
   <li><a href="xray.html">X-ray Databases</a>|</li>
   <li><a href="xrf.html">XRF Analysis</a>|</li>

          <li class="nav-item nav-item-1"><a href="xafs.html" ><span class="section-number">14. </span>XAFS Analysis</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">14.8. </span>XAFS: Fitting XAFS to Feff Paths</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright Matthew Newville, The University of Chicago, 2022.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.6.
    </div>
  </body>
</html>