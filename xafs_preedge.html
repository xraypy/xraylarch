

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>13.2. XAFS: Pre-edge Subtraction, Normalization, and data treatment &#8212; xraylarch 0.9.56 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/larchdoc.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="13.3. XANES Analysis: Linear Combination Analysis, Principal Component Analysis, Pre-edge Peak Fitting" href="xafs_xanes.html" />
    <link rel="prev" title="13.1. XAFS Functions: Overview and Naming Conventions" href="xafs_utilities.html" />

<script async src="https://badge.dimensions.ai/badge.js" charset="utf-8"></script>

<script type="text/x-mathjax-config">
   MathJax.Hub.Config({ "TeX": {Macros: {AA : "{\\unicode{x212B}}"}}, "HTML-CSS": {scale: 90}});
</script>


  </head><body>
<div style=" color: #c5daba;  text-align: left; height:65px; padding: 0px">
<table border=0>
  <tr>
    <td width=20%>
	<a href="index.html">
	 <img src="_static/larchcones.png" height=50px alt="larchcones"/></a>
    </td>
    <td width=75% padding=0>
      <font size=+2>
	<a href="index.html" style="color:#772211">
	  Larch: Data Analysis Tools for X-ray Spectroscopy
	</a>
      </font>
    </td>
   </tr></table>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="xafs_xanes.html" title="13.3. XANES Analysis: Linear Combination Analysis, Principal Component Analysis, Pre-edge Peak Fitting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="xafs_utilities.html" title="13.1. XAFS Functions: Overview and Naming Conventions"
             accesskey="P">previous</a> |</li>
   <li>[<a href="index.html"> Larch</a>|</li>
   <li><a href="getting_started.html"> Getting Started</a>|</li>
   <li><a href="xafs.html">XAFS Analysis</a>|</li>
   <li><a href="xray.html">X-ray Databases</a>|</li>
   <li><a href="xrf.html">XRF Analysis</a>|</li>

          <li class="nav-item nav-item-1"><a href="xafs.html" accesskey="U"><span class="section-number">13. </span>XAFS Analysis</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">13.2. </span>XAFS: Pre-edge Subtraction, Normalization, and data treatment</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">13.2. XAFS: Pre-edge Subtraction, Normalization, and data treatment</a><ul>
<li><a class="reference internal" href="#the-find-e0-function">13.2.1. The <code class="xref py py-func docutils literal notranslate"><span class="pre">find_e0()</span></code> function</a></li>
<li><a class="reference internal" href="#the-pre-edge-function">13.2.2. The <code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code> function</a></li>
<li><a class="reference internal" href="#pre-edge-subtraction-example">13.2.3. Pre-Edge Subtraction Example</a></li>
<li><a class="reference internal" href="#the-mback-algorithm">13.2.4. The MBACK algorithm</a></li>
<li><a class="reference internal" href="#pre-edge-baseline-subtraction">13.2.5. Pre-edge baseline subtraction</a></li>
<li><a class="reference internal" href="#over-absorption-corrections">13.2.6. Over-absorption Corrections</a></li>
<li><a class="reference internal" href="#spectral-deconvolution">13.2.7. Spectral deconvolution</a><ul>
<li><a class="reference internal" href="#xas-convolve">13.2.7.1. <code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code></a></li>
<li><a class="reference internal" href="#xas-deconvolve">13.2.7.2. <code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a></li>
<li><a class="reference internal" href="#examples-using-xas-deconvolve-and-xas-convolve">13.2.7.3. Examples using <code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="xafs_utilities.html"
                        title="previous chapter"><span class="section-number">13.1. </span>XAFS Functions: Overview and Naming Conventions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="xafs_xanes.html"
                        title="next chapter"><span class="section-number">13.3. </span>XANES Analysis:  Linear Combination Analysis,  Principal Component Analysis, Pre-edge Peak Fitting</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/xafs_preedge.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="xafs-pre-edge-subtraction-normalization-and-data-treatment">
<h1><span class="section-number">13.2. </span>XAFS: Pre-edge Subtraction, Normalization, and data treatment<a class="headerlink" href="#xafs-pre-edge-subtraction-normalization-and-data-treatment" title="Permalink to this headline">¶</a></h1>
<p>After reading in data and constructing <span class="math notranslate nohighlight">\(\mu(E)\)</span>, the principle
pre-processing steps for XAFS analysis are pre-edge subtraction and
normalization.  Reading data and constructing <span class="math notranslate nohighlight">\(\mu(E)\)</span> are handled by
internal larch functions, especially <code class="xref py py-func docutils literal notranslate"><span class="pre">read_ascii()</span></code>.  The main
XAFS-specific function for pre-edge subtraction and normalization is
<a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p>
<p>This chapter also describes methods for the treatment of XAFS and XANES
data including corrections for over-absorption (sometimes confusingly
called <em>self-absorption</em>) and for spectral convolution and de-convolution.</p>
<section id="the-find-e0-function">
<h2><span class="section-number">13.2.1. </span>The <code class="xref py py-func docutils literal notranslate"><span class="pre">find_e0()</span></code> function<a class="headerlink" href="#the-find-e0-function" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="larch.xafs.find_e0">
<span class="sig-prename descclassname"><span class="pre">larch.xafs.</span></span><span class="sig-name descname"><span class="pre">find_e0</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">energy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_larch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#larch.xafs.find_e0" title="Permalink to this definition">¶</a></dt>
<dd><p>calculate <span class="math notranslate nohighlight">\(E_0\)</span>, the energy threshold of absorption, or
‘edge energy’, given <span class="math notranslate nohighlight">\(\mu(E)\)</span>.</p>
<p><span class="math notranslate nohighlight">\(E_0\)</span> is found as the point with maximum derivative with
some checks to avoid spurious glitches.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> (<em>ndarray</em><em> or </em><em>group</em>) – array of x-ray energies, in eV, or group</p></li>
<li><p><strong>mu</strong> (<em>ndaarray</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – array of mu(E) values</p></li>
<li><p><strong>group</strong> (<em>group</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – output group</p></li>
<li><p><strong>_larch</strong> (<em>larch instance</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – current larch session.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Value of e0. If a group is provided, group.e0 will also be set.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)">float</a></p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ol class="arabic simple">
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a> convention, requiring group members <cite>energy</cite> and <cite>mu</cite></p></li>
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#set-xafs-group"><span class="std std-ref">group argument and _sys.xafsGroup</span></a> convention within Larch or if <cite>_larch</cite> is set.</p></li>
</ol>
</dd></dl>

</section>
<section id="the-pre-edge-function">
<h2><span class="section-number">13.2.2. </span>The <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a> function<a class="headerlink" href="#the-pre-edge-function" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="pre_edge">
<span class="sig-name descname"><span class="pre">pre_edge</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">energy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mu</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">e0</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre1</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pre2</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">norm1</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">norm2</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nnorm</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nvict</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pre_edge" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Pre-edge subtraction and normalization.  This performs a number of steps:</dt><dd><ol class="arabic simple">
<li><p>determine <span class="math notranslate nohighlight">\(E_0\)</span> (if not supplied) from max of deriv(mu)</p></li>
<li><p>fit a line of polynomial to the region below the edge</p></li>
<li><p>fit a polynomial to the region above the edge</p></li>
<li><p>extrapolate the two curves to <span class="math notranslate nohighlight">\(E_0\)</span> to determine the edge jump</p></li>
</ol>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of x-ray energies, in eV</p></li>
<li><p><strong>mu</strong> – 1-d array of <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>e0</strong> – edge energy, <span class="math notranslate nohighlight">\(E_0\)</span> in eV.  If None, it will be found.</p></li>
<li><p><strong>step</strong> – edge jump.  If None, it will be found here.</p></li>
<li><p><strong>pre1</strong> – low E range (relative to E0) for pre-edge fit. See Notes.</p></li>
<li><p><strong>pre2</strong> – high E range (relative to E0) for pre-edge fit. See Notes.</p></li>
<li><p><strong>norm1</strong> – low E range (relative to E0) for post-edge fit. See Notes.</p></li>
<li><p><strong>norm2</strong> – high E range (relative to E0) for post-edge fit. See Notes.</p></li>
<li><p><strong>nnorm</strong> – degree of polynomial (ie, norm+1 coefficients will be found) for
post-edge normalization curve. See Notes.</p></li>
<li><p><strong>nvict</strong> – energy exponent to use.  See Notes.</p></li>
<li><p><strong>make_flat</strong> – boolean (Default True) to calculate flattened output.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>None.</p>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members named
<code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">mu</span></code>.  The following data is put into the output
group:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>e0</p></td>
<td><p>energy origin</p></td>
</tr>
<tr class="row-odd"><td><p>edge_step</p></td>
<td><p>edge step</p></td>
</tr>
<tr class="row-even"><td><p>norm</p></td>
<td><p>normalized mu(E)   (array)</p></td>
</tr>
<tr class="row-odd"><td><p>flat</p></td>
<td><p>flattened, normalized mu(E)   (array)</p></td>
</tr>
<tr class="row-even"><td><p>pre_edge</p></td>
<td><p>pre-edge curve (array)</p></td>
</tr>
<tr class="row-odd"><td><p>post_edge</p></td>
<td><p>post-edge, normalization curve  (array)</p></td>
</tr>
<tr class="row-even"><td><p>pre_slope</p></td>
<td><p>slope of pre-edge line</p></td>
</tr>
<tr class="row-odd"><td><p>pre_offset</p></td>
<td><p>offset of pre-edge line</p></td>
</tr>
<tr class="row-even"><td><p>nvict</p></td>
<td><p>value of nvict used</p></td>
</tr>
<tr class="row-odd"><td><p>nnorm</p></td>
<td><p>value of nnorm used</p></td>
</tr>
<tr class="row-even"><td><p>norm_c0</p></td>
<td><p>constant of normalization polynomial</p></td>
</tr>
<tr class="row-odd"><td><p>norm_c1</p></td>
<td><p>linear coefficient of normalization polynomial</p></td>
</tr>
<tr class="row-even"><td><p>norm_c2</p></td>
<td><p>quadratic coefficient of normalization polynomial</p></td>
</tr>
<tr class="row-odd"><td><p>norm_c*</p></td>
<td><p>higher power coefficients of normalization polynomial</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

<p>For the pre-edge portion of the spectrum, a line is fit to <span class="math notranslate nohighlight">\(\mu(E)
E^{\rm{nvict}}\)</span> in the region <span class="math notranslate nohighlight">\(E={\rm{[e0+pre1, e0+pre2]}}\)</span>. <cite>pre1</cite>
and <cite>pre2</cite> default to <cite>None</cite>, which will set:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>pre1</cite> = <cite>e0</cite> - 2nd energy point</p></li>
<li><p><cite>pre2</cite> = roughly <cite>pre1/3.0</cite>, rounded to 5 eV steps</p></li>
</ul>
</div></blockquote>
<p>For the post-edge, a polynomial of order <cite>nnorm</cite> is fit to <span class="math notranslate nohighlight">\(\mu(E)
E^{\rm{nvict}}\)</span> in the region <span class="math notranslate nohighlight">\(E={\rm{[e0+norm1,
e0+norm2]}}\)</span>. <cite>norm1</cite>, <cite>norm2</cite>, and <cite>nnorm</cite> default to <cite>None</cite>, which will
set:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>norm2</cite> = max energy - <cite>e0</cite></p></li>
<li><p><cite>norm1</cite> = roughly <cite>norm2/3.0</cite>, rounded to 5 eV</p></li>
</ul>
</div></blockquote>
<p>The value for <cite>nnorm</cite> = 2 if <cite>norm2-norm1&gt;350</cite>, 1 if <cite>norm2-norm1&gt;50</cite>, or 0 if less.</p>
<p>The “flattened” <span class="math notranslate nohighlight">\(\mu(E)\)</span> is found by fitting a quadratic curve (no
matter the value of <cite>nnorm</cite>) to the post-edge normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> and
subtracts that curve from it.</p>
</section>
<section id="pre-edge-subtraction-example">
<h2><span class="section-number">13.2.3. </span>Pre-Edge Subtraction Example<a class="headerlink" href="#pre-edge-subtraction-example" title="Permalink to this headline">¶</a></h2>
<p>A simple example of pre-edge subtraction:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Larch</span>
<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;fe2o3_rt1.xmu&#39;</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy mu i0&#39;</span><span class="p">)</span>

<span class="n">pre_edge</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span>

<span class="n">plot_mu</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">show_pre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_post</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>or in plain Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">larch.io</span> <span class="kn">import</span> <span class="n">read_ascii</span>
<span class="kn">from</span> <span class="nn">larch.xafs</span> <span class="kn">import</span> <span class="n">pre_edge</span>
<span class="kn">from</span> <span class="nn">wxmplot.interactive</span> <span class="kn">import</span> <span class="n">plot</span>

<span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;fe2o3_rt1.xmu&#39;</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy mu i0&#39;</span><span class="p">)</span>

<span class="n">pre_edge</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span>

<span class="n">plot</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">,</span>
     <span class="n">title</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span><span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">pre_edge</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pre-edge line&#39;</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">post_edge</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;post-edge curve&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>gives the following results:</p>
<figure class="align-center" id="id5">
<span id="xafs-fig1"></span><a class="reference external image-reference" href="_images/xafs_preedge.png"><img alt="_images/xafs_preedge.png" src="_images/xafs_preedge.png" style="width: 65%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.3.1 </span><span class="caption-text">XAFS Pre-edge subtraction.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="the-mback-algorithm">
<h2><span class="section-number">13.2.4. </span>The MBACK algorithm<a class="headerlink" href="#the-mback-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Larch provides an implementation of the MBACK algorithm of
Weng <span id="id1">[<a class="reference internal" href="bibliography.html#id28" title="Tsu-Chien Weng, Geoffrey S. Waldo, and James E. Penner-Hahn. A method for normalization of X-ray absorption spectra. Journal of Synchrotron Radiation, 12(4):506–510, Jul 2005. doi:10.1107/S0909049504034193.">Weng, Waldo, and Penner-Hahn (2005)</a>]</span> with an option of using the modification proposed by
Lee <em>et al</em> <span id="id2">[<a class="reference internal" href="bibliography.html#id29" title="Julia C. Lee, Jingen Xiang, Bruce Ravel, Jeffrey Kortright, and Kathryn Flanagan. Condensed matter astrophysics: a prescription for determining the species-specific composition and quantity of interstellar dust using x-rays. The Astrophysical Journal, 702(2):970, 2009. URL: https://stacks.iop.org/0004-637X/702/i=2/a=970, doi:0004-637X/702/i=2/a=970.">Lee et al. (2009)</a>]</span>.  In MBACK, the data are matched to the tabulated
values of the imaginary part of the energy-dependent correction to the
Thompson scattering factor, <span class="math notranslate nohighlight">\(f''(E)\)</span>.  To account for any
instrumental or sample-dependent aspects of the shape of the measured
data, <span class="math notranslate nohighlight">\(\mu_{data}(E)\)</span>, a Legendre polynomial of order <span class="math notranslate nohighlight">\(m\)</span>
centered around the absorption edge is subtracted from the data.  To
account for the sort of highly non-linear pre-edge which often results
from Compton scattering in the measurement window of an
energy-discriminating detector, a complementary error function is
added to the Legendre polynomial.</p>
<p>The form of the normalization function, then, is</p>
<div class="math notranslate nohighlight">
\[\mu_{back}(E) = \left[\sum_0^m C_i(E-E_0)^i\right] + A\cdot\operatorname{erfc}\left((E-E_{em}\right)/\xi)\]</div>
<p>where <span class="math notranslate nohighlight">\(A\)</span>, <span class="math notranslate nohighlight">\(E_{em}\)</span>, and <span class="math notranslate nohighlight">\(\xi\)</span> are the amplitude,
centroid, and width of the complementary error function and <span class="math notranslate nohighlight">\(s\)</span>
is a scaling factor for the measured data.  <span class="math notranslate nohighlight">\(E_{em}\)</span> is
typically the centroid of the emission line for the measured edge.
This results in a function of <span class="math notranslate nohighlight">\(3+m\)</span> variables (a tabulated value
of <span class="math notranslate nohighlight">\(E_{em}\)</span> is used).  The function to be minimized, then is</p>
<div class="math notranslate nohighlight">
\[\frac{1}{n_1} \sum_{1}^{n_1} \left[\mu_{tab}(E) + \mu_{back}(E) + s\cdot\mu_{data}(E)\right]^2 +
\frac{1}{n_2} \sum_{n_1+1}^{N} \left[\mu_{tab}(E) + \mu_{back}(E) + s\cdot\mu_{data}(E)\right]^2\]</div>
<p>To give weight in the fit to the pre-edge region, which typically has
fewer measured points than the post-edge region, the weight is
adjusted by breaking the minimization function into two regions: the
<span class="math notranslate nohighlight">\(n_1\)</span> data points below the absorption edge and the <span class="math notranslate nohighlight">\(n_2\)</span>
data points above the absorption edge.  <span class="math notranslate nohighlight">\(n_1+n_2=N\)</span>, where N is
the total number of data points.</p>
<p>If this is used in publication, a citation should be given to Weng <span id="id3">[<a class="reference internal" href="bibliography.html#id28" title="Tsu-Chien Weng, Geoffrey S. Waldo, and James E. Penner-Hahn. A method for normalization of X-ray absorption spectra. Journal of Synchrotron Radiation, 12(4):506–510, Jul 2005. doi:10.1107/S0909049504034193.">Weng, Waldo, and Penner-Hahn (2005)</a>]</span>.</p>
<dl class="py function">
<dt class="sig sig-object py" id="mback">
<span class="sig-name descname"><span class="pre">mback</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">energy</span></em>, <em class="sig-param"><span class="pre">mu</span></em>, <em class="sig-param"><span class="pre">group=None</span></em>, <em class="sig-param"><span class="pre">...</span></em><span class="sig-paren">)</span><a class="headerlink" href="#mback" title="Permalink to this definition">¶</a></dt>
<dd><p>Match measured <span class="math notranslate nohighlight">\(\mu(E)\)</span> data to tabulated cross-section data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of x-ray energies, in eV</p></li>
<li><p><strong>mu</strong> – 1-d array of <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>z</strong> – the Z number of the absorber</p></li>
<li><p><strong>edge</strong> – the absorption edge, usually ‘K’ or ‘L3’</p></li>
<li><p><strong>e0</strong> – edge energy, <span class="math notranslate nohighlight">\(E_0\)</span> in eV.  If None, the tabulated value is used.</p></li>
<li><p><strong>emin</strong> – the minimum energy to include in the fit.  If None, use first energy point</p></li>
<li><p><strong>emax</strong> – the maximum energy to include in the fit.  If None, use last energy point</p></li>
<li><p><strong>whiteline</strong> – a margin around the edge to exclude from the fit.  If not None, must be a positive integer</p></li>
<li><p><strong>leexiang</strong> – flag for using the use the Lee&amp;Xiang extension [False]</p></li>
<li><p><strong>tables</strong> – ‘CL’ (Cromer-Liberman) or ‘Chantler’, [‘Chantler’]</p></li>
<li><p><strong>fit_erfc</strong> – if True, fit the amplitude and width of the complementary error function [False]</p></li>
<li><p><strong>return_f1</strong> – if True, put f1 in the output group [False]</p></li>
<li><p><strong>pre_edge_kws</strong> – dictionary containing keyword arguments to pass to <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>None.</p>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members named
<code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">mu</span></code>.  The following data is put into the output
group:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>fpp</p></td>
<td><p>matched <span class="math notranslate nohighlight">\(\mu(E)\)</span> data</p></td>
</tr>
<tr class="row-odd"><td><p>f2</p></td>
<td><p>tabulated <span class="math notranslate nohighlight">\(f''(E)\)</span> data</p></td>
</tr>
<tr class="row-even"><td><p>f1</p></td>
<td><p>tabulated <span class="math notranslate nohighlight">\(f'(E)\)</span> data (if <code class="docutils literal notranslate"><span class="pre">return_f1</span></code> is True)</p></td>
</tr>
<tr class="row-odd"><td><p>mback_params</p></td>
<td><p>params group for the MBACK minimization function</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

<p>Notes:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">whiteline</span></code> parameter is used to exclude the region around the
white line in the data from the fit.  The large spectral weight under
the white line can skew the fit result, particularly in data
measured over a short data range.  The value is eV units.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is the order of the Legendre polynomial.
Data measured over a very short data range are likely best processed
with <code class="docutils literal notranslate"><span class="pre">order=2</span></code>.  Extended XAS data are often better processed with
a value of 3 or 4.  The order is enforced to be an integer between 1
and 6.</p></li>
<li><p>A call to <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a> is made if <code class="docutils literal notranslate"><span class="pre">e0</span></code> is not supplied.</p></li>
<li><p>The option to return <span class="math notranslate nohighlight">\(f'(E)\)</span> is used by <a class="reference internal" href="xafs_diffkk.html#diffkk" title="diffkk"><code class="xref py py-func docutils literal notranslate"><span class="pre">diffkk()</span></code></a>.</p></li>
</ul>
</div></blockquote>
<p>Here is an example of processing XANES data measured over an extended
data range.  This example is the K edge of copper foil, with the
result shown in <a class="reference internal" href="#fig-mback-copper"><span class="std std-numref">Figure 13.2.4.1</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">larch.io</span> <span class="kn">import</span> <span class="n">read_ascii</span>
<span class="kn">from</span> <span class="nn">larch.xafs</span> <span class="kn">import</span> <span class="n">mback</span>
<span class="kn">from</span> <span class="nn">wxmplot.interactive</span> <span class="kn">import</span> <span class="n">plot</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_10k.xmu&#39;</span><span class="p">)</span>
<span class="n">mback</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">f2</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;matched absorption&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_2$&#39;</span><span class="p">,</span>
     <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">fpp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Copper foil&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="id6">
<span id="fig-mback-copper"></span><a class="reference external image-reference" href="_images/mback_copper.png"><img alt="_images/mback_copper.png" src="_images/mback_copper.png" style="width: 65%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.4.1 </span><span class="caption-text">Using MBACK to match Cu K edge data measured on a copper foil.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>Here is an example of processing XANES data measured over a rather
short data range.  This example is the magnesium silicate mineral
talc, Mg<sub>3</sub>Si<sub>4</sub>O<sub>10</sub>(OH)<sub>2</sub>,
measured at the Si K edge, with the result shown in
<a class="reference internal" href="#fig-mback-talc"><span class="std std-numref">Figure 13.2.4.2</span></a>.  Note that the order of the Legendre polynomial
is set to 2 and that the <code class="docutils literal notranslate"><span class="pre">whiteline</span></code> parameter is set to avoid the
large features near the edge.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">=</span><span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;Talc.xmu&#39;</span><span class="p">)</span>
<span class="n">mback</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">xmu</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">whiteline</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fit_erfc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">newplot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">f2</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;matched absorption&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f_2$&#39;</span><span class="p">,</span>
        <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">fpp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Talc ($\mathrm</span><span class="si">{Mg}</span><span class="s1">_3\mathrm</span><span class="si">{Si}</span><span class="s1">_4\mathrm</span><span class="si">{O}</span><span class="s1">_</span><span class="si">{10}</span><span class="s1">\mathrm{(OH)}_2$)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="id7">
<span id="fig-mback-talc"></span><a class="reference external image-reference" href="_images/mback_talc.png"><img alt="_images/mback_talc.png" src="_images/mback_talc.png" style="width: 65%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.4.2 </span><span class="caption-text">Using MBACK to match Si K edge data measured on talc.</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<dl class="py function">
<dt class="sig sig-object py" id="mback_norm">
<span class="sig-name descname"><span class="pre">mback_norm</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="pre">energy</span></em>, <em class="sig-param"><span class="pre">mu</span></em>, <em class="sig-param"><span class="pre">group=None</span></em>, <em class="sig-param"><span class="pre">...</span></em><span class="sig-paren">)</span><a class="headerlink" href="#mback_norm" title="Permalink to this definition">¶</a></dt>
<dd><p>A simplified version of <a class="reference internal" href="#mback" title="mback"><code class="xref py py-func docutils literal notranslate"><span class="pre">mback()</span></code></a> to normalize <span class="math notranslate nohighlight">\(\mu(E)\)</span> data
to tabulated cross-section data for <span class="math notranslate nohighlight">\(f''(E)\)</span>.</p>
<dl class="simple">
<dt>Returns:</dt><dd><p>group.norm_poly:     normalized mu(E) from pre_edge()
group.norm:          normalized mu(E) from this method
group.mback_mu:      tabulated f2 scaled and pre_edge added to match mu(E)
group.mback_params:  Group of parameters for the minimization</p>
</dd>
<dt>References:</dt><dd><ul class="simple">
<li><p>MBACK (Weng, Waldo, Penner-Hahn): <a class="reference external" href="https://dx.doi.org/10.1086/303711">https://dx.doi.org/10.1086/303711</a></p></li>
<li><p>Chantler: <a class="reference external" href="https://dx.doi.org/10.1063/1.555974">https://dx.doi.org/10.1063/1.555974</a></p></li>
</ul>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of x-ray energies, in eV</p></li>
<li><p><strong>mu</strong> – 1-d array of <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>z</strong> – the Z number of the absorber</p></li>
<li><p><strong>edge</strong> – the absorption edge, usually ‘K’ or ‘L3’</p></li>
<li><p><strong>e0</strong> – edge energy, <span class="math notranslate nohighlight">\(E_0\)</span> in eV.  If None, the tabulated value is used.</p></li>
<li><p><strong>pre1</strong> – low E range (relative to E0) as for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
<li><p><strong>pre2</strong> – high E range (relative to E0) as for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
<li><p><strong>norm1</strong> – low E range (relative to E0) as for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
<li><p><strong>norm2</strong> – high E range (relative to E0) as for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
<li><p><strong>nnorm</strong> – degree of polynomial as for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
</ul>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members
named <code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">mu</span></code>.  The following data is put into the output
group:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>norm_poly</p></td>
<td><p>normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> from <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></td>
</tr>
<tr class="row-odd"><td><p>norm</p></td>
<td><p>normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> from this method/</p></td>
</tr>
<tr class="row-even"><td><p>mback_mu</p></td>
<td><p>tabulated <span class="math notranslate nohighlight">\(f'(E)\)</span> scaler and pre-edge added</p></td>
</tr>
<tr class="row-odd"><td><p>mback_params</p></td>
<td><p>params group for the MBACK minimization function</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

</section>
<section id="pre-edge-baseline-subtraction">
<h2><span class="section-number">13.2.5. </span>Pre-edge baseline subtraction<a class="headerlink" href="#pre-edge-baseline-subtraction" title="Permalink to this headline">¶</a></h2>
<p>A common application of XAFS is the analysis of “pre-edge peaks” of
transition metal oxides to determine oxidation state and molecular
configuration. These peaks sit just below the main absorption edge
(typically, due to metal <em>4p</em> electrons) of a main <em>K</em> edge, and are due to
overlaps of the metal <em>d</em>-electrons and oxygen <em>p</em>-electrons, and are often
described in terms of molecular orbital theory.</p>
<p>To analyze the energies and relative strengths of these pre-edge peaks, it
is necessary to try to remove the contribution of the main edge.  The main
edge (or at least its low energy side) can be modeled reasonably well as a
Lorentzian function for these purposes of describing the tail below the
pre-edge peaks.</p>
<dl class="py function">
<dt class="sig sig-object py" id="larch.xafs.prepeaks_setup">
<span class="sig-prename descclassname"><span class="pre">larch.xafs.</span></span><span class="sig-name descname"><span class="pre">prepeaks_setup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#larch.xafs.prepeaks_setup" title="Permalink to this definition">¶</a></dt>
<dd><p>set up pre edge peak group.</p>
<p>This assumes that pre_edge() has been run successfully on the spectra
and that the spectra has decent pre-edge subtraction and normalization.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> (<em>ndarray</em><em> or </em><em>group</em>) – array of x-ray energies, in eV, or group (see note 1)</p></li>
<li><p><strong>norm</strong> (<em>ndarray</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – array of normalized mu(E)</p></li>
<li><p><strong>group</strong> (<em>group</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – output group</p></li>
<li><p><strong>emax</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – max energy (eV) to use for baesline fit [e0-5]</p></li>
<li><p><strong>emin</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – min energy (eV) to use for baesline fit [e0-40]</p></li>
<li><p><strong>elo</strong> – (float or None)       low energy of pre-edge peak region to not fit baseline [e0-20]</p></li>
<li><p><strong>ehi</strong> – (float or None)       high energy of pre-edge peak region ot not fit baseline [e0-10]</p></li>
<li><p><strong>_larch</strong> (<em>larch instance</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – current larch session.</p></li>
</ul>
</dd>
</dl>
<p>A group named <cite>prepeaks</cite> will be created in the output group, containing:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>energy</p></td>
<td><p>energy array for pre-edge peaks = energy[emin:emax]</p></td>
</tr>
<tr class="row-odd"><td><p>norm</p></td>
<td><p>spectrum over pre-edge peak energies</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="rubric">Notes</p>
<ol class="arabic simple">
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a> convention, requiring group members <cite>energy</cite> and <cite>norm</cite></p></li>
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#set-xafs-group"><span class="std std-ref">group argument and _sys.xafsGroup</span></a> convention within Larch or if <cite>_larch</cite> is set.</p></li>
</ol>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="larch.xafs.pre_edge_baseline">
<span class="sig-prename descclassname"><span class="pre">larch.xafs.</span></span><span class="sig-name descname"><span class="pre">pre_edge_baseline</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#larch.xafs.pre_edge_baseline" title="Permalink to this definition">¶</a></dt>
<dd><p>remove baseline from main edge over pre edge peak region</p>
<p>This assumes that pre_edge() has been run successfully on the spectra
and that the spectra has decent pre-edge subtraction and normalization.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> (<em>ndarray</em><em> or </em><em>group</em>) – array of x-ray energies, in eV, or group (see note 1)</p></li>
<li><p><strong>norm</strong> (<em>ndarray</em><em> or </em><em>group</em>) – array of normalized mu(E)</p></li>
<li><p><strong>group</strong> (<em>group</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – output group</p></li>
<li><p><strong>elo</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – low energy of pre-edge peak region to not fit baseline [e0-20]</p></li>
<li><p><strong>ehi</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – high energy of pre-edge peak region ot not fit baseline [e0-10]</p></li>
<li><p><strong>emax</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – max energy (eV) to use for baesline fit [e0-5]</p></li>
<li><p><strong>emin</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)"><em>float</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – min energy (eV) to use for baesline fit [e0-40]</p></li>
<li><p><strong>form</strong> (<em>string</em>) – form used for baseline (see description)  [‘linear+lorentzian’]</p></li>
<li><p><strong>_larch</strong> (<em>larch instance</em><em> or </em><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)"><em>None</em></a>) – current larch session.</p></li>
</ul>
</dd>
</dl>
<p>A function will be fit to the input mu(E) data over the range between
[emin:elo] and [ehi:emax], ignorng the pre-edge peaks in the region
[elo:ehi].  The baseline function is specified with the <cite>form</cite> keyword
argument, which can be one or a combination of ‘lorentzian’, ‘gaussian’, or ‘voigt’,
plus one of ‘constant’, ‘linear’, ‘quadratic’, for example, ‘linear+lorentzian’,
‘constant+voigt’, ‘quadratic’, ‘gaussian’.</p>
<p>A group named ‘prepeaks’ will be used or created in the output group, containing</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 81%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>energy</p></td>
<td><p>energy array for pre-edge peaks = energy[emin:emax]</p></td>
</tr>
<tr class="row-odd"><td><p>baseline</p></td>
<td><p>fitted baseline array over pre-edge peak energies</p></td>
</tr>
<tr class="row-even"><td><p>norm</p></td>
<td><p>spectrum over pre-edge peak energies</p></td>
</tr>
<tr class="row-odd"><td><p>peaks</p></td>
<td><p>baseline-subtraced spectrum over pre-edge peak energies</p></td>
</tr>
<tr class="row-even"><td><p>centroid</p></td>
<td><p>estimated centroid of pre-edge peaks (see note 3)</p></td>
</tr>
<tr class="row-odd"><td><p>peak_energies</p></td>
<td><p>list of predicted peak energies (see note 4)</p></td>
</tr>
<tr class="row-even"><td><p>fit_details</p></td>
<td><p>details of fit to extract pre-edge peaks.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="rubric">Notes</p>
<ol class="arabic simple">
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a> convention, requiring group members <cite>energy</cite> and <cite>norm</cite></p></li>
<li><p>Supports <a class="reference internal" href="xafs_utilities.html#set-xafs-group"><span class="std std-ref">group argument and _sys.xafsGroup</span></a> convention within Larch or if <cite>_larch</cite> is set.</p></li>
<li><p>The value calculated for <cite>prepeaks.centroid</cite>  will be found as
(prepeaks.energy*prepeaks.peaks).sum() / prepeaks.peaks.sum()</p></li>
<li><p>The values in the <cite>peak_energies</cite> list will be predicted energies
of the peaks in <cite>prepeaks.peaks</cite> as found by peakutils.</p></li>
</ol>
</dd></dl>

</section>
<section id="over-absorption-corrections">
<h2><span class="section-number">13.2.6. </span>Over-absorption Corrections<a class="headerlink" href="#over-absorption-corrections" title="Permalink to this headline">¶</a></h2>
<p>For XAFS data measured in fluorescence, a common problem of
<em>over-absorption</em> in which too much of the total X-ray absorption
coefficient is from the absorbing element.  In such cases, the implicit
assumption in a fluorescence XAFS measurement that the fluorescence
intensity is proportional to the absorption coefficient of the element of
interest breaks down.  This is often referred to as <em>self-absorption</em> in
the older XAFS literature, but the term should be avoided as it is quite a
different effect from self-absorption in X-ray fluorescence analysis.  In
fact, the effect is more like <em>extinction</em> in that the fluorescence
probability approaches a constant, with no XAFS oscillations, as the total
absorption coefficient is dominated by the element of interest.
Over-absorption most strongly effects the XAFS oscillation amplitude, and so
coordination number and mean-square displacement parameters in the EXAFS,
and edge-position and pre-edge peak height for XANES.  Fortunately, the
effect can be corrected for small over-absorption.</p>
<p>For XANES, a common correction method from the FLUO program by D. Haskel
(<span id="id4">[<a class="reference internal" href="bibliography.html#id52" title="D. Haskel. Fluo. 1999. URL: {https://www.aps.anl.gov/~haskel/fluo.html}.">Haskel (1999)</a>]</span>) can be used.  The algorithm is contained in the
<a class="reference internal" href="#fluo_corr" title="fluo_corr"><code class="xref py py-func docutils literal notranslate"><span class="pre">fluo_corr()</span></code></a> function.</p>
<dl class="py function">
<dt class="sig sig-object py" id="fluo_corr">
<span class="sig-name descname"><span class="pre">fluo_corr</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">energy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mu</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">formula</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">elem</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">edge</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'K'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">anginp</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">45</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">angout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">45</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">pre_kws</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#fluo_corr" title="Permalink to this definition">¶</a></dt>
<dd><p>calculate <span class="math notranslate nohighlight">\(\mu(E)\)</span> corrected for over-absorption in fluorescence
XAFS using the FLUO algorithm (suitable for XANES, but questionable for
EXAFS).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of x-ray energies, in eV</p></li>
<li><p><strong>mu</strong> – 1-d array of <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>formula</strong> – string for sample stoichiometry</p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>elem</strong> – atomic symbol (‘Zn’) or Z of absorbing element</p></li>
<li><p><strong>edge</strong> – name of edge (‘K’, ‘L3’, …) [default ‘K’]</p></li>
<li><p><strong>anginp</strong> – input angle in degrees  [default 45]</p></li>
<li><p><strong>angout</strong> – output angle in degrees [default 45]</p></li>
<li><p><strong>pre_kws</strong> – additional keywords for <a class="reference internal" href="#pre_edge" title="pre_edge"><code class="xref py py-func docutils literal notranslate"><span class="pre">pre_edge()</span></code></a>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members named
<code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">mu</span></code>.  The value of <code class="docutils literal notranslate"><span class="pre">mu_corr</span></code> and <code class="docutils literal notranslate"><span class="pre">norm_corr</span></code> will
be written to the output group, containing <span class="math notranslate nohighlight">\(\mu(E)\)</span> and
normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> corrected for over-absorption.</p>
</dd></dl>

</section>
<section id="spectral-deconvolution">
<h2><span class="section-number">13.2.7. </span>Spectral deconvolution<a class="headerlink" href="#spectral-deconvolution" title="Permalink to this headline">¶</a></h2>
<p>In order to readily compare XAFS data from different sources, it is
sometimes necessary to consider the energy resolution used to collect each
spectum.  To be clear, the resolution of an EXAFS spectrum includes
contributions from the x-ray sources, instrumental broadening from the x-ray
optics (especially the X-ray monochromator used in most measurements), and
the intrinsic lifetime of the excited core electronic level.  For data
measured in X-ray fluorescence or electron emission mode, the energy
resolution can also includes the energy width of the decay channels
measured.</p>
<p>For a large fraction of XAFS data, the energy resolution is dominated by
the intrinsic width of the excited core level and by the resolution of a
silicon (111) double crystal monochromator, and so does not vary
appreciably between spectra taken at different facilities or at different
times.  Exceptions to this rule occur when using a higher order reflection
of a silicon monochromator or a different monochromator altogether.
Resolution can also be noticeably worse for data taken at older (first and
second generation) sources and beamlines, either without a collimating
mirror or slits before the monochromator to improve the resolution.
In addition, high-resolution X-ray fluorescence measurements can be used to
dramatically enhance the energy resolution of XAFS spectra, and are
becoming widely available.</p>
<p>Because of these effects, it is sometimes useful to change the resolution
of XAFS spectra.  For example, one may need to reduce the resolution to
match data measured with degraded resolution.  This can be done with
<code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code> which convolves an XAFS spectrum with either a
Gaussian or Lorentzian function with a known energy width.  Note that
convolving with a Gaussian is less dramatic than using a Lorentzian, and
usually better reflects the effect of an incident X-ray beam with degraded
resolution due to source or monochromator.</p>
<p>One may also want to try to improve the energy resolution of an XAFS
spectrum, either to compare it to data taken with higher resolution or to
better identify and enumerate peaks in a XANES spectrum.  This can be done
with <a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a> function which de-convolves either a Gaussian or
Lorentzian function from an XAFS spectrum.  This usually requires fairly
good data.  Whereas a Gaussian most closely reflects broadening from the
X-ray source, broadening due to the natural energy width of the core levels
is better described by a Lorentzian.   Therefore, to try to reduce the
influence of the core level in order better mimic high-resolution
fluorescence data, de-convolving with a Lorentzian is often better.</p>
<section id="xas-convolve">
<h3><span class="section-number">13.2.7.1. </span><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code><a class="headerlink" href="#xas-convolve" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">xas_convolve(energy,</span> <span class="pre">norm=None,</span> <span class="pre">group=None,</span> <span class="pre">form='lorentzian',</span> <span class="pre">esigma=1.0,</span> <span class="pre">eshift=0.0):</span></span></dt>
<dd><p>convolve a normalized mu(E) spectra with a Lorentzian or Gaussian peak
shape, degrading separation of XANES features.</p>
<p>This is provided as a complement to xas_deconvolve, and to deliberately
broaden spectra to compare with spectra measured at lower resolution.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of <span class="math notranslate nohighlight">\(E\)</span></p></li>
<li><p><strong>norm</strong> – 1-d array of normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>form</strong> – form of deconvolution function. One of
‘lorentzian’ or  ‘gaussian’ [‘lorentzian’]</p></li>
<li><p><strong>esigma</strong> – energy <span class="math notranslate nohighlight">\(\sigma\)</span> (in eV) to pass to
<a class="reference internal" href="fitting_lineshapes.html#gaussian" title="gaussian"><code class="xref py py-func docutils literal notranslate"><span class="pre">gaussian()</span></code></a> or <a class="reference internal" href="fitting_lineshapes.html#lorentzian" title="lorentzian"><code class="xref py py-func docutils literal notranslate"><span class="pre">lorentzian()</span></code></a> lineshape [1.0]</p></li>
<li><p><strong>eshift</strong> – energy shift (in eV) to apply to result. [0.0]</p></li>
</ul>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members named
<code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">norm</span></code>.  The following data is put into the output
group:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>conv</p></td>
<td><p>array of convolved, normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

</section>
<section id="xas-deconvolve">
<h3><span class="section-number">13.2.7.2. </span><a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a><a class="headerlink" href="#xas-deconvolve" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="xas_deconvolve">
<span class="sig-name descname"><span class="pre">xas_deconvolve</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">energy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">norm</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">form</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'lorentzian'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">esigma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eshift</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">smooth</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sgwindow</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sgorder</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">3</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#xas_deconvolve" title="Permalink to this definition">¶</a></dt>
<dd><p>XAS spectral deconvolution</p>
<p>de-convolve a normalized mu(E) spectra with a peak shape, enhancing the
intensity and separation of peaks of a XANES spectrum.</p>
<p>The results can be unstable, and noisy, and should be used
with caution!</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> – 1-d array of <span class="math notranslate nohighlight">\(E\)</span></p></li>
<li><p><strong>norm</strong> – 1-d array of normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></li>
<li><p><strong>group</strong> – output group</p></li>
<li><p><strong>form</strong> – form of deconvolution function. One of
‘lorentzian’ or  ‘gaussian’ [‘lorentzian’]</p></li>
<li><p><strong>esigma</strong> – energy <span class="math notranslate nohighlight">\(\sigma\)</span> (in eV) to pass to
<a class="reference internal" href="fitting_lineshapes.html#gaussian" title="gaussian"><code class="xref py py-func docutils literal notranslate"><span class="pre">gaussian()</span></code></a> or <a class="reference internal" href="fitting_lineshapes.html#lorentzian" title="lorentzian"><code class="xref py py-func docutils literal notranslate"><span class="pre">lorentzian()</span></code></a> lineshape [1.0]</p></li>
<li><p><strong>eshift</strong> – energy shift (in eV) to apply to result. [0.0]</p></li>
<li><p><strong>smooth</strong> – whether to smooth the result with the Savitzky-Golay
method [<code class="docutils literal notranslate"><span class="pre">True</span></code>]</p></li>
<li><p><strong>sgwindow</strong> – window size for Savitzky-Golay function [found from data step and esigma]</p></li>
<li><p><strong>sgorder</strong> – order for the Savitzky-Golay function [3]</p></li>
</ul>
</dd>
</dl>
<p>Follows the <a class="reference internal" href="xafs_utilities.html#first-argument-group"><span class="std std-ref">First Argument Group convention</span></a>, using group members named
<code class="docutils literal notranslate"><span class="pre">energy</span></code> and <code class="docutils literal notranslate"><span class="pre">norm</span></code>.</p>
<p>Smoothing with <code class="xref py py-func docutils literal notranslate"><span class="pre">savitzky_golay()</span></code> requires a window and order.  By
default, <code class="docutils literal notranslate"><span class="pre">window</span> <span class="pre">=</span> <span class="pre">int(esigma</span> <span class="pre">/</span> <span class="pre">estep)</span></code> where estep is step size for
the gridded data, approximately the finest energy step in the data.</p>
<p>The following data is put into the output group:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>deconv</p></td>
<td><p>array of deconvolved, normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span></p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

</section>
<section id="examples-using-xas-deconvolve-and-xas-convolve">
<h3><span class="section-number">13.2.7.3. </span>Examples using <a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a> and <code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code><a class="headerlink" href="#examples-using-xas-deconvolve-and-xas-convolve" title="Permalink to this headline">¶</a></h3>
<p>An example using <a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a> to deconvolve a XAFS spectrum would
be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/xafs/doc_deconv1.lar</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/fe2o3_rt1.xmu&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy mu i0&#39;</span><span class="p">)</span>

<span class="n">pre_edge</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
<span class="n">xas_deconvolve</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">esigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">plot_mu</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">show_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">emin</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">deconv</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;deconvolved&#39;</span><span class="p">)</span>

<span class="c1">## end of examples/xafs/doc_deconv1.lar</span>
</pre></div>
</div>
<p>resulting in deconvolved data:</p>
<figure class="align-center" id="id8">
<span id="fig-deconv-fe"></span><a class="reference external image-reference" href="_images/xafs_deconv1.png"><img alt="_images/xafs_deconv1.png" src="_images/xafs_deconv1.png" style="width: 65%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.7.1 </span><span class="caption-text">Deconvolved XAFS spectrum for <span class="math notranslate nohighlight">\(\rm Fe_2O_3\)</span>.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>To de-convolve an XAFS spectrum using the energy width of the core level,
we can use the <a class="reference internal" href="xray.html#xray.core_width" title="_xray.core_width"><code class="xref py py-func docutils literal notranslate"><span class="pre">_xray.core_width()</span></code></a> function, as shown below for Cu metal.
We can also test that the deconvolution is correct by using
<code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code> to re-convolve the result and comparing it to original
data.  This can be done with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/xafs/doc_deconv2.lar</span>

<span class="n">dat</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/cu_metal_rt.xdi&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy i0 i1 mu&#39;</span><span class="p">)</span>
<span class="n">dat</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">i1</span> <span class="o">/</span> <span class="n">dat</span><span class="o">.</span><span class="n">i0</span><span class="p">)</span>

<span class="n">pre_edge</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

<span class="n">esigma</span> <span class="o">=</span> <span class="n">core_width</span><span class="p">(</span><span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>

<span class="n">xas_deconvolve</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">esigma</span><span class="o">=</span><span class="n">esigma</span><span class="p">)</span>

<span class="n">plot_mu</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">show_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">emin</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">deconv</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;deconvolved&#39;</span><span class="p">)</span>

<span class="c1"># Test convolution:</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">dat</span><span class="o">.</span><span class="n">deconv</span><span class="p">)</span>
<span class="n">xas_convolve</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">esigma</span><span class="o">=</span><span class="n">esigma</span><span class="p">)</span>
<span class="n">plot_mu</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">show_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">emin</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">conv</span><span class="o">-</span><span class="n">dat</span><span class="o">.</span><span class="n">norm</span><span class="p">),</span>
     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;(reconvolved - original)x100&#39;</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">## end of examples/xafs/doc_deconv2.lar</span>
</pre></div>
</div>
<p>with results shown below:</p>
<div class="figure compound align-center" id="fig_xafs_deconv">
<figure class="align-center" id="id9">
<span id="fig-xafs-deconv2a"></span><a class="reference external image-reference" href="_images/xafs_deconv2a.png"><img alt="_images/xafs_deconv2a.png" src="_images/xafs_deconv2a.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.7.2 </span><span class="caption-text">XAS for Cu metal normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> and spectrum
deconvolved by the energy of its core level.</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id10">
<span id="fig-xafs-deconv2b"></span><a class="reference external image-reference" href="_images/xafs_deconv2b.png"><img alt="_images/xafs_deconv2b.png" src="_images/xafs_deconv2b.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-number">Figure 13.2.7.3 </span><span class="caption-text">Comparison of original and re-convolved XAS spectrum for Cu metal.
The difference shown in red is multiplied by 100.</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><span class="caption-text">Example of simple usage of <a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code> for Cu metal.</span></p>
</div><p id="fig_xafs_deconv">Finally, de-convolution of <span class="math notranslate nohighlight">\(L_{\rm III}\)</span> XAFS data can be
particularly dramatic and useful.  As with the copper spectrum above, we’ll
deconvolve <span class="math notranslate nohighlight">\(L_{\rm III}\)</span> XAFS for platinum, using the nominal energy
width of the core level (5.17 eV).  For this example, we also see
noticeable improvement in amplitude of the XAFS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## examples/xafs/doc_deconv3.lar</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">read_ascii</span><span class="p">(</span><span class="s1">&#39;../xafsdata/pt_metal_rt.xdi&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="s1">&#39;energy time i1 i0&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">i1</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">i0</span><span class="p">)</span>

<span class="n">pre_edge</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">xftf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">kwindow</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">xas_deconvolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">esigma</span><span class="o">=</span><span class="n">core_width</span><span class="p">(</span><span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="s1">&#39;L3&#39;</span><span class="p">))</span>

<span class="n">decon</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">deconv</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="n">autobk</span><span class="p">(</span><span class="n">decon</span><span class="p">,</span> <span class="n">rbkg</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">xftf</span><span class="p">(</span><span class="n">decon</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">dk</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">kwindow</span><span class="o">=</span><span class="s1">&#39;kaiser&#39;</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># plot in E</span>
<span class="n">plot_mu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">show_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">emin</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">deconv</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;deconvolved&#39;</span><span class="p">,</span>  <span class="n">win</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plot in k</span>
<span class="n">plot_chik</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_window</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot_chik</span><span class="p">(</span><span class="n">decon</span><span class="p">,</span> <span class="n">kweight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_window</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;deconvolved&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># plot in R</span>
<span class="n">plot_chir</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>  <span class="n">win</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot_chir</span><span class="p">(</span><span class="n">decon</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;deconvolved&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">## end examples/xafs/doc_deconv3.lar</span>
</pre></div>
</div>
<p>with results shown below:</p>
<div class="figure compound align-center" id="fig_xafs_deconv3">
<figure class="align-center" id="fig-xafs-deconv3a">
<a class="reference external image-reference" href="_images/xafs_deconv3a.png"><img alt="_images/xafs_deconv3a.png" src="_images/xafs_deconv3a.png" style="width: 100%;" /></a>
</figure>
<figure class="align-center" id="fig-xafs-deconv3b">
<a class="reference external image-reference" href="_images/xafs_deconv3b.png"><img alt="_images/xafs_deconv3b.png" src="_images/xafs_deconv3b.png" style="width: 100%;" /></a>
</figure>
<p><span class="caption-text">Example of simple usage of <a class="reference internal" href="#xas_deconvolve" title="xas_deconvolve"><code class="xref py py-func docutils literal notranslate"><span class="pre">xas_deconvolve()</span></code></a> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">xas_convolve()</span></code> for <span class="math notranslate nohighlight">\(L_{\rm III}\)</span> XAFS of Pt metal.
<span class="math notranslate nohighlight">\(L_{\rm III}\)</span> XAFS of Pt metal, normalized <span class="math notranslate nohighlight">\(\mu(E)\)</span> for raw
data and the spectrum deconvolved by the energy of its core level.</span></p>
<span class="target" id="fig_xafs_deconv3"></span></div></section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="xafs_xanes.html" title="13.3. XANES Analysis: Linear Combination Analysis, Principal Component Analysis, Pre-edge Peak Fitting"
             >next</a> |</li>
        <li class="right" >
          <a href="xafs_utilities.html" title="13.1. XAFS Functions: Overview and Naming Conventions"
             >previous</a> |</li>
   <li>[<a href="index.html"> Larch</a>|</li>
   <li><a href="getting_started.html"> Getting Started</a>|</li>
   <li><a href="xafs.html">XAFS Analysis</a>|</li>
   <li><a href="xray.html">X-ray Databases</a>|</li>
   <li><a href="xrf.html">XRF Analysis</a>|</li>

          <li class="nav-item nav-item-1"><a href="xafs.html" ><span class="section-number">13. </span>XAFS Analysis</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">13.2. </span>XAFS: Pre-edge Subtraction, Normalization, and data treatment</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright Matthew Newville, The University of Chicago, 2020.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>